<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>&#24322;&#24120; - &#28404;&#27700;&#36870;&#21521;&#35838;&#31243;&#31508;&#35760;</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="1015827">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">BinaryLearning</span>
                    <img class="space-logo" src="global.logo" />
                </h1>
                <a href="Binary-Learning.html" class="ht-space-link">
                    <h2>&#28404;&#27700;&#36870;&#21521;&#35838;&#31243;&#31508;&#35760;</h2>
                </a>
                <p><br><a href="https://github.com/gh0stkey/Binary-Learning" target="_blank">ᴀᴜᴛʜᴏʀ: ᴋᴇʏ</a><br><br>不积跬步，无以至千里；<br>不积小流，无以成江海。</p>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=2949166"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Binary-Learning.html">&#28404;&#27700;&#36870;&#21521;&#35838;&#31243;&#31508;&#35760;</a></li>
                                                                                     <li><a href="%E4%B8%AD%E7%BA%A7%E7%AF%87.html">&#20013;&#32423;&#31687;</a></li>
                                                            </ul>
</div>            <h1 id="src-2949166"> <span>&#24322;&#24120;</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>&#22914;&#26524;&#20320;&#24076;&#26395;&#22312;&#36719;&#20214;&#35843;&#35797;&#19978;&#26377;&#25152;&#31361;&#30772;&#65292;&#25110;&#32773;&#24819;&#20102;&#35299;&#22914;&#20309;&#36890;&#36807;&#24322;&#24120;&#36827;&#34892;&#21453;&#35843;&#35797;&#65292;&#25110;&#32773;&#24819;&#33258;&#24049;&#20889;&#19968;&#20010;&#35843;&#35797;&#22120;&#65292;&#37027;&#20040;&#23601;&#24517;&#39035;&#35201;&#28145;&#20837;&#20102;&#35299;&#24322;&#24120;&#65292;&#24322;&#24120;&#19982;&#35843;&#35797;&#26159;&#32039;&#23494;&#30456;&#36830;&#30340;&#65292;&#24322;&#24120;&#26159;&#35843;&#35797;&#30340;&#22522;&#30784;&#12290;</p>
<p   
>&#24322;&#24120;&#20135;&#29983;&#21518;&#65292;&#39318;&#20808;&#26159;&#35201;&#35760;&#24405;&#24322;&#24120;&#20449;&#24687;&#65288;&#24322;&#24120;&#30340;&#31867;&#22411;&#12289;&#24322;&#24120;&#21457;&#29983;&#30340;&#20301;&#32622;&#31561;&#65289;&#65292;&#28982;&#21518;&#35201;&#23547;&#25214;&#24322;&#24120;&#30340;&#22788;&#29702;&#20989;&#25968;&#65292;&#25105;&#20204;&#31216;&#20026;&#24322;&#24120;&#30340;&#20998;&#21457;&#65292;&#26368;&#21518;&#25214;&#21040;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#24182;&#35843;&#29992;&#65292;&#25105;&#20204;&#31216;&#20026;&#24322;&#24120;&#22788;&#29702;&#12290;&#25105;&#20204;&#21518;&#32493;&#30340;&#23398;&#20064;&#65292;&#20063;&#26159;&#22260;&#32469;&#24322;&#24120;&#30340;&#12289;&#20998;&#21457;&#12289;&#22788;&#29702;&#12290;</p>
    <div class="section section-1" id="src-2949166_safe-id-aWQt5byC5bi4LeW8guW4uOiusOW9lQ">
        <h1 class="heading "><span>&#24322;&#24120;&#35760;&#24405;</span></h1>
<p   
>&#24322;&#24120;&#21487;&#20197;&#31616;&#21333;&#20998;&#20026;2&#31867;&#65292;&#21363;<strong class=" ">CPU&#20135;&#29983;&#30340;&#24322;&#24120;</strong>&#21644;<strong class=" ">&#36719;&#20214;&#27169;&#25311;&#20135;&#29983;&#30340;&#24322;&#24120;</strong>&#65292;&#22914;&#19979;&#20004;&#24352;&#22270;&#25152;&#31034;&#65292;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#31532;&#19968;&#24352;&#22270;&#20013;&#36827;&#34892;&#20102;&#38500;&#27861;&#36816;&#31639;&#65292;CPU&#26816;&#27979;&#21040;&#38500;&#25968;&#20026;0&#65292;&#23601;&#20135;&#29983;&#20102;&#24322;&#24120;&#65307;&#31532;&#20108;&#24352;&#22270;&#20013;&#20351;&#29992;&#20102;throw&#20851;&#38190;&#35789;&#65292;&#36890;&#36807;&#36719;&#20214;&#27169;&#25311;&#20027;&#21160;&#20135;&#29983;&#20102;&#24322;&#24120;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_20-56-53.png" alt="images/download/attachments/2949166/image2023-5-25_20-56-53.png" width="400"  />
    </p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_20-57-1.png" alt="images/download/attachments/2949166/image2023-5-25_20-57-1.png" width="400"  />
    </p>
    <div class="section section-2" id="src-2949166_safe-id-aWQt5byC5bi4LUNQVeeahOW8guW4uOiusOW9lQ">
        <h2 class="heading "><span>CPU&#30340;&#24322;&#24120;&#35760;&#24405;</span></h2>
<p   
>&#25105;&#20204;&#20808;&#20102;&#35299;&#19968;&#20010;&#32467;&#26500;&#20307;_EXCEPTION_RECORD&#65292;&#23427;&#30340;&#26684;&#24335;&#21450;&#27599;&#20010;&#25104;&#21592;&#30340;&#24847;&#20041;&#22914;&#19979;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">typedef struct _EXCEPTION_RECORD {</code></div>
<div class="line"><code class="plain">    DWORD ExceptionCode; </code><code class="comments">// 异常状态码，在Windows中每一种状态（包括异常）都有一个状态码</code></div>
<div class="line"><code class="plain">    DWORD ExceptionFlags; </code><code class="comments">// 异常状态，0表示CPU异常，1表示软件模拟异常，8表示堆栈异常</code></div>
<div class="line"><code class="plain">    struct _EXCEPTION_RECORD *ExceptionRecord; </code><code class="comments">// 通常情况下该值为空，如果发生嵌套异常（即处理异常时又出现了异常）则指向下一个异常</code></div>
<div class="line"><code class="plain">    PVOID ExceptionAddress; </code><code class="comments">// 异常发生地址，表示异常发生时的位置</code></div>
<div class="line"><code class="plain">    DWORD NumberParameters; </code><code class="comments">// 附加参数个数</code></div>
<div class="line"><code class="plain">    ULONG_PTR ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS]; </code><code class="comments">// 附加参数指针</code></div>
<div class="line"><code class="plain">} EXCEPTION_RECORD, *PEXCEPTION_RECORD;</code></div>
</div>
    </div>
<p   
>Windows&#29366;&#24577;&#30721;&#21450;&#20854;&#23545;&#24212;&#21547;&#20041;&#65292;&#25105;&#20204;&#21487;&#20197;&#22312;&#22312;&#32447;&#25991;&#26723;&#20013;&#33719;&#21462;&#65306;<a  class="external-link" href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55">https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55</a>&#65292;&#22914;&#19979;&#22270;&#25152;&#31034;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#65292;&#25972;&#25968;&#38500;0&#26102;&#30340;&#24322;&#24120;&#29366;&#24577;&#30721;&#20026;0xC0000094&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_21-36-30.png" alt="images/download/attachments/2949166/image2023-5-25_21-36-30.png" width="600"  />
    </p>
<p   
>&#25509;&#30528;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#38500;0&#30340;&#20363;&#23376;&#26469;&#30475;&#19968;&#19979;CPU&#30340;&#24322;&#24120;&#35760;&#24405;&#36807;&#31243;&#65292;&#23427;&#30340;&#22823;&#33268;&#36807;&#31243;&#23601;&#26159;&#65306;<strong class=" ">CPU&#25351;&#20196;&#26816;&#27979;&#21040;&#24322;&#24120;&rarr;&#26597;IDT&#34920;&#25191;&#34892;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&rarr;&#25191;&#34892;CommonDispatchException&rarr;&#25191;&#34892;KiDispatchException</strong>&#12290;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;IDA&#25171;&#24320;Ntoskrnl.exe&#20808;&#25214;&#21040;IDT&#34920;&#65292;&#36890;&#36807;ALT+T&#24555;&#25463;&#38190;&#20840;&#23616;&#25628;&#32034;_IDT&#65292;&#25214;&#21040;IDT&#34920;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_21-47-45.png" alt="images/download/attachments/2949166/image2023-5-25_21-47-45.png" width="600"  />
    </p>
<p   
>&#26681;&#25454;&#19979;&#22270;&#25152;&#31034;&#30340;&#20013;&#26029;&#25551;&#36848;&#31526;&#34920;&#25105;&#20204;&#21487;&#20197;&#30693;&#36947;&#38500;0&#24322;&#24120;&#23545;&#24212;&#30340;0&#21495;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#65292;&#22240;&#27492;&#25105;&#20204;&#23601;&#21487;&#20197;&#22312;IDA&#20013;&#36827;&#20837;&#23545;&#24212;&#30340;&#22788;&#29702;&#20989;&#25968;&#65306;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_21-50-9.png" alt="images/download/attachments/2949166/image2023-5-25_21-50-9.png" width="600"  />
    </p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_21-51-19.png" alt="images/download/attachments/2949166/image2023-5-25_21-51-19.png" width="600"  />
    </p>
<p   
>&#35813;&#20989;&#25968;&#30340;&#21069;&#38754;&#19968;&#37096;&#20998;&#20195;&#30721;&#21644;KiSystemService&#20989;&#25968;&#65288;&#31995;&#32479;&#35843;&#29992;API&#36827;0&#29615;&#65289;&#30340;&#20195;&#30721;&#19968;&#26679;&#65292;&#37117;&#26159;&#29992;&#26469;&#20445;&#23384;&#29616;&#22330;&#30340;&#65306;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_21-54-40.png" alt="images/download/attachments/2949166/image2023-5-25_21-54-40.png" width="400"  />
    </p>
<p   
>&#25509;&#30528;&#21521;&#19979;&#21487;&#20197;&#30475;&#21040;&#65292;&#35813;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#30452;&#33267;&#25191;&#34892;&#32467;&#26463;&#37117;&#27809;&#26377;&#23545;&#24322;&#24120;&#36827;&#34892;&#22788;&#29702;&#65288;&#24494;&#36719;&#22312;&#35774;&#35745;&#26102;&#65292;&#24076;&#26395;&#31243;&#24207;&#21592;&#33258;&#24049;&#33021;&#22815;&#23545;&#24322;&#24120;&#36827;&#34892;&#22788;&#29702;&#65292;&#22240;&#27492;<strong class=" ">&#22312;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#20013;&#24182;&#27809;&#26377;&#23545;&#24322;&#24120;&#36827;&#34892;&#22788;&#29702;</strong>&#65289;&#65292;&#21453;&#32780;&#26159;&#26377;&#22810;&#22788;&#30340;&#36339;&#36716;&#65292;&#35843;&#29992;&#20102;&#21478;&#19968;&#20010;&#20989;&#25968;CommonDispatchException&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_22-0-10.png" alt="images/download/attachments/2949166/image2023-5-25_22-0-10.png" width="600"  />
    </p>
<p   
>&#36319;&#36827;CommonDispatchException&#20989;&#25968;&#65292;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#23427;&#24320;&#36767;&#20102;&#19968;&#22359;&#22823;&#23567;&#20026;0x50&#30340;&#31354;&#38388;&#65292;&#29992;&#20110;&#23384;&#25918;_EXCEPTION_RECORD&#32467;&#26500;&#20307;&#65292;&#24182;&#19988;&#32473;&#32467;&#26500;&#20307;&#30340;&#27599;&#20010;&#25104;&#21592;&#36171;&#20540;&#65292;&#26368;&#32456;&#25191;&#34892;KiDispatchException&#20989;&#25968;&#65292;&#35813;&#20989;&#25968;&#36890;&#24120;&#29992;&#26469;<strong class=" ">&#20998;&#21457;&#24322;&#24120;</strong>&#65292;&#30446;&#30340;&#26159;&#25214;&#21040;&#24322;&#24120;&#30340;&#22788;&#29702;&#20989;&#25968;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_22-8-38.png" alt="images/download/attachments/2949166/image2023-5-25_22-8-38.png" width="600"  />
    </p>
<p   
>&#20854;&#20013;&#24322;&#24120;&#29366;&#24577;&#30721;&#26159;&#26469;&#33258;&#19978;&#23618;&#30340;EAX&#65292;&#36825;&#28857;&#25105;&#20204;&#36890;&#36807;&#20043;&#21069;&#30340;&#27969;&#31243;&#23601;&#21487;&#20197;&#30693;&#36947;&#65292;&#25509;&#30528;&#25105;&#20204;&#26469;&#30475;&#24322;&#24120;&#21457;&#29983;&#22320;&#22336;&#65288;&#21363;ExceptionAddress&#65289;&#26159;&#26469;&#33258;&#19978;&#23618;&#30340;EBX&#65292;&#32780;EBX&#21448;&#26469;&#33258;[EBP+0x68]&#65292;&#36825;&#37324;&#23454;&#38469;&#19978;&#25351;&#30340;&#26159;Trap_Frame&#32467;&#26500;&#20307;0x68&#20559;&#31227;&#20301;Eip&#25104;&#21592;&#65292;&#23427;&#26159;&#29992;&#26469;&#35760;&#24405;&#20013;&#26029;&#21457;&#29983;&#22320;&#22336;&#30340;&#65292;&#36825;&#26159;&#22240;&#20026;&#22312;&#20445;&#23384;&#29616;&#22330;&#32467;&#26463;&#20043;&#21518;&#65292;<strong class=" ">ESP&#25351;&#21521;Trap_Frame&#30340;&#39030;&#37096;&#65292;&#32780;EBP&#20063;&#19982;ESP&#19968;&#26679;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-25_22-22-29.png" alt="images/download/attachments/2949166/image2023-5-25_22-22-29.png" width="400"  />
    </p>
    </div>
    <div class="section section-2" id="src-2949166_safe-id-aWQt5byC5bi4Lei9r-S7tuaooeaLn-eahOW8guW4uOiusOW9lQ">
        <h2 class="heading "><span>&#36719;&#20214;&#27169;&#25311;&#30340;&#24322;&#24120;&#35760;&#24405;</span></h2>
<p   
>&#25105;&#20204;&#25509;&#30528;&#26469;&#30475;&#19968;&#19979;throw&#20851;&#38190;&#35789;&#35302;&#21457;&#30340;&#36719;&#20214;&#27169;&#25311;&#24322;&#24120;&#35760;&#24405;&#36807;&#31243;&#65292;&#22312;&#20851;&#38190;&#35789;&#22788;&#19979;&#26029;&#28857;&#65292;&#28982;&#21518;&#36816;&#34892;&#36890;&#36807;&#21453;&#27719;&#32534;&#20195;&#30721;&#25105;&#20204;&#21487;&#20197;&#30693;&#36947;&#23427;&#35843;&#29992;&#30340;&#23601;&#26159;CxxThrowException&#20989;&#25968;&#65306;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-26_12-30-18.png" alt="images/download/attachments/2949166/image2023-5-26_12-30-18.png" width="500"  />
    </p>
<p   
>&#36319;&#36827;&#35813;&#20989;&#25968;&#65292;&#20250;&#21457;&#29616;&#23427;&#20063;&#26159;&#35843;&#29992;&#20102;&#21478;&#22806;&#19968;&#20010;&#20989;&#25968;RaiseException&#65292;&#24182;&#36890;&#36807;&#26632;&#30340;&#26041;&#24335;&#21387;&#20837;&#20102;&#20960;&#20010;&#20256;&#21442;&#65306;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-26_12-36-14.png" alt="images/download/attachments/2949166/image2023-5-26_12-36-14.png" width="600"  />
    </p>
<p   
>&#25509;&#30528;&#25105;&#20204;&#36319;&#36827;RaiseException&#20989;&#25968;&#21457;&#29616;&#65292;&#27491;&#26159;&#36825;&#20960;&#20010;&#20256;&#21442;&#22635;&#20805;&#20102;_EXCEPTION_RECORD&#32467;&#26500;&#20307;&#65292;&#22312;&#36825;&#37324;&#25105;&#20204;&#20250;&#21457;&#29616;&#20004;&#20010;&#27604;&#36739;&#20851;&#38190;&#25104;&#21592;&#30340;&#20540;&#37117;&#19982;CPU&#24322;&#24120;&#35760;&#24405;&#26102;&#30340;&#36171;&#20540;&#20869;&#23481;&#19981;&#19968;&#33268;&#65292;&#39318;&#20808;&#26159;ExceptionCode&#65292;&#23427;&#30340;&#20540;&#24456;&#26126;&#26174;&#26159;&#19968;&#20010;Windows&#24322;&#24120;&#29366;&#24577;&#30721;&#20013;&#27809;&#26377;&#30340;&#65288;&#21363;0xE06D7363&#65289;&#65292;&#36825;&#26159;&#22240;&#20026;&#22312;&#36719;&#20214;&#27169;&#25311;&#20135;&#29983;&#30340;&#24322;&#24120;&#22330;&#26223;&#19979;&#65292;<strong class=" ">ExceptionCode&#30340;&#20540;&#26159;&#26681;&#25454;&#19981;&#21516;&#30340;&#32534;&#35793;&#29615;&#22659;&#32780;&#29983;&#25104;&#30340;</strong>&#65307;&#20854;&#27425;&#26159;ExceptionAddress&#65292;&#22914;&#19979;&#22270;&#20013;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#65292;<strong class=" ">&#23427;&#30340;&#20540;&#26159;RasieException&#20989;&#25968;&#30340;&#39318;&#22320;&#22336;</strong>&#65292;&#32780;&#24182;&#19981;&#26159;&#30495;&#27491;&#20135;&#29983;&#24322;&#24120;&#30340;&#37027;&#27573;&#22320;&#22336;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-26_12-45-24.png" alt="images/download/attachments/2949166/image2023-5-26_12-45-24.png" width="600"  />
    </p>
<p   
>RaiseException&#20989;&#25968;&#20043;&#21518;&#30340;&#27969;&#31243;&#26159;&#36825;&#26679;&#30340;&#65306;RtlRaiseException&rarr;NtRaiseException&rarr;KiRaiseException&#65292;&#22312;&#26368;&#21518;&#25191;&#34892;&#21040;KiRaiseException&#20989;&#25968;&#26102;&#65292;<strong class=" ">&#20250;&#23558;ExceptionCode&#30340;&#26368;&#39640;&#20301;&#28165;0&#65292;&#20415;&#20110;&#21306;&#20998;CPU/&#36719;&#20214;&#27169;&#25311;&#24322;&#24120;</strong>&#65306;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-26_12-53-55.png" alt="images/download/attachments/2949166/image2023-5-26_12-53-55.png" width="600"  />
    </p>
<p   
>&#34429;&#28982;&#27169;&#25311;&#24322;&#24120;&#19982;CPU&#24322;&#24120;&#26377;&#19968;&#23450;&#30340;&#24046;&#24322;&#65292;&#20294;&#26159;&#22312;&#26368;&#21518;&#65292;<strong class=" ">&#20004;&#32773;&#37117;&#20250;&#21435;&#35843;&#29992;KiDispatchException&#20989;&#25968;&#65292;&#29992;&#20110;&#24322;&#24120;&#20998;&#21457;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-26_12-56-19.png" alt="images/download/attachments/2949166/image2023-5-26_12-56-19.png" width="500"  />
    </p>
    </div>
    </div>
    <div class="section section-1" id="src-2949166_safe-id-aWQt5byC5bi4LeW8guW4uOWIhuWPkeS4juWkhOeQhg">
        <h1 class="heading "><span>&#24322;&#24120;&#20998;&#21457;&#19982;&#22788;&#29702;</span></h1>
<p   
>&#24322;&#24120;&#21487;&#20197;&#21457;&#29983;&#22312;&#29992;&#25143;&#31354;&#38388;&#65292;&#20063;&#21487;&#20197;&#21457;&#29983;&#22312;&#20869;&#26680;&#31354;&#38388;&#12290;&#26080;&#35770;&#26159;CPU&#24322;&#24120;&#36824;&#26159;&#27169;&#25311;&#24322;&#24120;&#65292;&#26080;&#35770;&#26159;&#29992;&#25143;&#31354;&#38388;&#24322;&#24120;&#36824;&#26159;&#20869;&#26680;&#31354;&#38388;&#24322;&#24120;&#65292;<strong class=" ">&#26368;&#32456;&#37117;&#35201;&#36890;&#36807;KiDispatchException&#20989;&#25968;&#36827;&#34892;&#20998;&#21457;</strong>&#65292;&#29702;&#35299;&#36825;&#20010;&#20989;&#25968;&#26159;&#23398;&#22909;&#24322;&#24120;&#30340;&#20851;&#38190;&#65292;&#36825;&#20010;&#20989;&#25968;&#27604;&#36739;&#22797;&#26434;&#65292;&#25105;&#20204;&#20197;&#20869;&#26680;&#12289;&#29992;&#25143;&#20004;&#20010;&#35282;&#24230;&#26469;&#20998;&#26512;&#23398;&#20064;&#12290;</p>
    <div class="section section-2" id="src-2949166_safe-id-aWQt5byC5bi4LeWGheaguOW8guW4uA">
        <h2 class="heading "><span>&#20869;&#26680;&#24322;&#24120;</span></h2>
<p   
>&#26412;&#31456;&#25105;&#20204;&#20027;&#35201;&#20998;&#26512;&#20869;&#26680;&#24322;&#24120;&#26159;&#22914;&#20309;&#20998;&#21457;&#65292;&#22914;&#20309;&#22788;&#29702;&#30340;&#12290;&#39318;&#20808;&#25105;&#20204;&#38656;&#35201;&#26469;&#20102;&#35299;&#19968;&#19979;KiDispatchException&#20989;&#25968;&#30340;&#26684;&#24335;&#65292;&#21450;&#27599;&#20010;&#21442;&#25968;&#30340;&#20316;&#29992;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">VOID KiDispatchException (</code></div>
<div class="line"><code class="plain">    PEXCEPTION_RECORD ExceptionRecord, </code><code class="comments">// 异常记录结构体</code></div>
<div class="line"><code class="plain">    PKEXCEPTION_FRAME ExceptionFrame,  </code><code class="comments">// X86系统下，该值为NULL</code></div>
<div class="line"><code class="plain">    PKTRAP_FRAME TrapFrame,            </code><code class="comments">// 3环进0环保存现场所用的结构体</code></div>
<div class="line"><code class="plain">    KPROCESSOR_MODE PreviousMode,      </code><code class="comments">// 先前模式，表示调用来自什么模式，0表示内核模式，1表示用户模式</code></div>
<div class="line"><code class="plain">    BOOLEAN FirstChance                </code><code class="comments">// 判断是否是第一次分发这个异常，对于同一个异常，Windows最多分发两次</code></div>
<div class="line"><code class="plain">                                       </code><code class="comments">// 该值为1表示第一次分发，为0表示第二次分发</code></div>
<div class="line"><code class="plain">)</code></div>
</div>
    </div>
<p   
>&#36890;&#36807;IDA&#30452;&#25509;&#25171;&#24320;Ntoskrnl.exe&#27169;&#22359;&#65292;&#25214;&#21040;KiDispatchException&#20989;&#25968;&#65292;&#35813;&#20989;&#25968;&#26368;&#24320;&#22987;&#23601;&#26159;&#20808;&#35843;&#29992;_KeContextFromKframes&#20989;&#25968;&#65292;&#23558;Trap_Frame&#22791;&#20221;&#21040;_Context&#20013;&#65292;&#20026;&#36820;&#22238;3&#29615;&#20570;&#20934;&#22791;&#65288;&#36825;&#37324;&#19982;&#29992;&#25143;APC&#25191;&#34892;&#36807;&#31243;&#19968;&#26679;&#65292;<strong class=" ">&#22240;&#20026;&#35813;&#20989;&#25968;&#25903;&#25345;&#20869;&#26680;&#12289;&#29992;&#25143;&#31354;&#38388;&#30340;&#24322;&#24120;&#20998;&#21457;&#21644;&#22788;&#29702;</strong>&#65292;&#22240;&#27492;&#25105;&#20204;&#19981;&#30693;&#36947;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#21040;&#24213;&#26159;&#22312;&#29992;&#25143;&#31354;&#38388;&#36824;&#26159;&#20869;&#26680;&#31354;&#38388;&#65292;&#25152;&#20197;&#31532;&#19968;&#20214;&#20107;&#24773;&#23601;&#26159;&#22791;&#20221;Trap_Frame&#65292;<strong class=" ">&#20415;&#20110;&#20013;&#36884;&#22238;&#21040;3&#29615;</strong>&#65289;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-26_16-45-29.png" alt="images/download/attachments/2949166/image2023-5-26_16-45-29.png" width="600"  />
    </p>
<p   
>&#25509;&#30528;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#23427;&#20250;&#21435;<strong class=" ">&#21028;&#26029;&#20808;&#21069;&#27169;&#24335;</strong>&#65292;&#22914;&#26524;&#20808;&#21069;&#27169;&#24335;<strong class=" ">&#20026;1&#21017;&#36827;&#20837;&#29992;&#25143;&#31354;&#38388;&#30340;&#24322;&#24120;&#22788;&#29702;&#36923;&#36753;</strong>&#65292;&#20026;0&#21017;&#25509;&#30528;&#21521;&#19979;<strong class=" ">&#21028;&#26029;FirstChance</strong>&#65292;&#21363;&#24403;&#21069;&#24322;&#24120;&#26159;&#21542;&#20026;&#31532;&#19968;&#27425;&#20998;&#21457;&#65292;&#22914;&#26524;&#26159;&#31532;&#19968;&#27425;&#21017;&#32487;&#32493;&#21521;&#19979;<strong class=" ">&#21028;&#26029;&#24403;&#21069;&#26159;&#21542;&#26377;&#20869;&#26680;&#35843;&#35797;&#22120;</strong>&#65292;&#22914;&#26524;&#27809;&#26377;&#20869;&#26680;&#35843;&#35797;&#22120;&#21017;&#36339;&#36716;&#65292;<strong class=" ">&#26377;&#20869;&#26680;&#35843;&#35797;&#22120;&#30340;&#35805;&#20248;&#20808;&#35843;&#29992;&#20869;&#26680;&#35843;&#35797;&#22120;&#20989;&#25968;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-26_17-1-49.png" alt="images/download/attachments/2949166/image2023-5-26_17-1-49.png" width="600"  />
    </p>
<p   
>&#25509;&#30528;&#25105;&#20204;&#21521;&#19979;&#30475;&#65292;&#20250;&#21457;&#29616;&#27809;&#26377;&#20869;&#26680;&#35843;&#35797;&#22120;&#65292;&#25110;&#32773;&#20869;&#26680;&#35843;&#35797;&#22120;&#20989;&#25968;&#36820;&#22238;&#32467;&#26524;&#20026;0&#30340;&#24773;&#20917;&#19979;&#65292;<strong class=" ">&#37117;&#20250;&#36339;&#36716;&#33267;&#21516;&#19968;&#20195;&#30721;&#27573;</strong>&#65307;&#36825;&#37324;&#38656;&#35201;&#35828;&#26126;&#19979;&#20869;&#26680;&#35843;&#35797;&#22120;&#20989;&#25968;&#36820;&#22238;&#32467;&#26524;<strong class=" ">&#20026;0&#21017;&#34920;&#31034;&#24322;&#24120;&#26410;&#34987;&#22788;&#29702;</strong>&#65292;<strong class=" ">&#20026;1&#21017;&#34920;&#31034;&#24322;&#24120;&#34987;&#22788;&#29702;&#20102;</strong>&#65292;&#28982;&#21518;&#20250;&#23558;<strong class=" ">_Context&#36716;&#25442;&#25104;Trap_Frame&#36820;&#36824;</strong>&#65292;&#24322;&#24120;&#22788;&#29702;&#36807;&#31243;&#32467;&#26463;&#65292;&#36864;&#20986;KiDispatchException&#20989;&#25968;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-29_9-32-12.png" alt="images/download/attachments/2949166/image2023-5-29_9-32-12.png" width="600"  />
    </p>
<p   
>&#28982;&#21518;&#25105;&#20204;&#36319;&#36827;&#23427;&#20204;&#37117;&#36339;&#36716;&#36827;&#30340;&#20195;&#30721;&#27573;&#20250;&#21457;&#29616;&#36825;&#37324;&#35843;&#29992;&#20102;RtlDispatchException&#20989;&#25968;&#65292;&#36825;&#20010;&#20989;&#25968;&#19987;&#38376;&#36127;&#36131;&#35843;&#29992;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#26469;&#22788;&#29702;&#24322;&#24120;&#65292;<strong class=" ">&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#35813;&#20989;&#25968;&#35843;&#29992;&#26102;&#20505;&#20256;&#36882;&#20102;&#20004;&#20010;&#21442;&#25968;&#65292;&#21363;Context&#21644;ExceptionRecord</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-26_17-8-14.png" alt="images/download/attachments/2949166/image2023-5-26_17-8-14.png" width="600"  />
    </p>
<p   
>&#36319;&#36827;RtlDispatchException&#20989;&#25968;&#65288;&#35813;&#20989;&#25968;&#26159;&#19968;&#20010;&#24211;&#20989;&#25968;&#65292;&#20869;&#26680;&#21644;&#29992;&#25143;&#24322;&#24120;&#37117;&#20250;&#20351;&#29992;&#23427;&#26469;&#36827;&#34892;&#20998;&#21457;&#65292;<strong class=" ">&#22312;&#26412;&#31456;&#31616;&#21333;&#20102;&#35299;&#19968;&#19979;&#65292;&#21518;&#32493;&#29992;&#25143;&#24322;&#24120;&#20998;&#21457;&#21644;&#22788;&#29702;&#25105;&#20204;&#35814;&#32454;&#36827;&#34892;&#20998;&#26512;</strong>&#65289;&#65292;&#25105;&#20204;&#20250;&#21457;&#29616;&#20854;&#35843;&#29992;&#20102;RtlpGetRegistrationHead&#20989;&#25968;&#65292;&#23427;&#30340;&#20316;&#29992;&#23601;&#26159;&#33719;&#21462;FS:[0]&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-26_17-27-33.png" alt="images/download/attachments/2949166/image2023-5-26_17-27-33.png" width="800"  />
    </p>
<p   
>&#26681;&#25454;&#20043;&#21069;&#30340;&#23398;&#20064;&#65292;&#25105;&#20204;&#30693;&#36947;&#22312;<strong class=" ">0&#29615;&#30340;FS:[0]&#25351;&#21521;&#30340;&#26159;_KPCR&#32467;&#26500;&#20307;</strong>&#65292;_KPCR&#30340;&#31532;&#19968;&#20010;&#25104;&#21592;&#26159;NtTib&#65292;&#32780;NtTib&#30340;<strong class=" ">&#31532;&#19968;&#20010;&#23383;&#27573;&#26159;ExceptionList</strong>&#65292;ExceptionList&#36825;&#20010;&#23383;&#27573;&#26159;&#19968;&#20010;&#25351;&#38024;&#65292;&#23427;&#25351;&#21521;&#20102;&#19968;&#20010;&#32467;&#26500;&#20307;_EXCEPTION_REGISTRATION_RECORD&#65292;&#35813;&#32467;&#26500;&#20307;&#26377;2&#20010;&#25104;&#21592;&#65292;&#31532;&#19968;&#20010;<strong class=" ">&#25104;&#21592;Next&#25351;&#21521;&#19979;&#19968;&#20010;_EXCEPTION_REGISTRATION_RECORD&#32467;&#26500;&#20307;&#22320;&#22336;</strong>&#65288;&#22914;&#26524;&#27809;&#26377;&#19979;&#19968;&#20010;&#32467;&#26500;&#20307;&#65292;&#21017;&#35813;&#20540;&#20026;-1&#65289;&#65292;<strong class=" ">&#31532;&#20108;&#20010;&#25104;&#21592;Handler&#25351;&#21521;&#20102;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;</strong>&#12290;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">kd&gt; dt _EXCEPTION_REGISTRATION_RECORD</code></div>
<div class="line"><code class="plain">nt!_EXCEPTION_REGISTRATION_RECORD</code></div>
<div class="line"><code class="plain">   +</code><code class="value">0x000</code><code class="plain"> Next             : Ptr32 _EXCEPTION_REGISTRATION_RECORD</code></div>
<div class="line"><code class="plain">   +</code><code class="value">0x004</code><code class="plain"> Handler          : Ptr32 _EXCEPTION_DISPOSITION </code></div>
</div>
    </div>
<p   
>&#25152;&#20197;RtlDispatchException&#30340;&#20316;&#29992;&#23601;&#26159;&#36941;&#21382;&#24322;&#24120;&#38142;&#34920;&#65292;&#35843;&#29992;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#65292;<strong class=" ">&#22914;&#26524;&#24322;&#24120;&#34987;&#27491;&#30830;&#22788;&#29702;&#20102;&#65292;&#35813;&#20989;&#25968;&#36820;&#22238;1</strong>&#65307;&#22914;&#26524;&#24403;&#21069;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#19981;&#33021;&#22788;&#29702;&#35813;&#24322;&#24120;&#65292;&#23601;&#35843;&#29992;&#19979;&#19968;&#20010;&#65292;&#20197;&#27492;&#31867;&#25512;<strong class=" ">&#21040;&#26368;&#21518;&#20063;&#27809;&#26377;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#22788;&#29702;&#36825;&#20010;&#24322;&#24120;&#65292;&#21017;&#35813;&#20989;&#25968;&#36820;&#22238;0</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-29_10-0-53.png" alt="images/download/attachments/2949166/image2023-5-29_10-0-53.png" width="400"  />
    </p>
<p   
>&#22914;&#26524;RtlDispatchException&#20989;&#25968;&#36820;&#22238;0&#65292;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#23427;&#21448;&#20250;&#21435;&#21028;&#26029;&#24403;&#21069;&#26159;&#21542;&#26377;&#20869;&#26680;&#35843;&#35797;&#22120;&#65292;&#21644;&#19978;&#38754;&#30340;&#27969;&#31243;&#19968;&#26679;&#65292;&#21457;&#29616;&#27809;&#26377;&#20869;&#26680;&#35843;&#35797;&#22120;&#65292;&#25110;&#32773;&#20869;&#26680;&#35843;&#35797;&#22120;&#20989;&#25968;&#36820;&#22238;&#32467;&#26524;&#20026;0&#30340;&#24773;&#20917;&#19979;&#65292;&#36339;&#36716;&#33267;&#21516;&#19968;&#20195;&#30721;&#27573;&#65292;&#35813;&#20195;&#30721;&#27573;&#30340;&#20316;&#29992;&#23601;&#26159;&#34013;&#23631;&#65288;KeBugCheckEx&#23601;&#26159;Windows&#25191;&#34892;&#23849;&#28291;&#30340;&#20989;&#25968;&#65292;&#20316;&#29992;&#23601;&#26159;<strong class=" ">&#20351;&#35745;&#31639;&#26426;&#34013;&#23631;</strong>&#65289;&#12290;</p>
<p   
><br/></p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-29_10-8-8.png" alt="images/download/attachments/2949166/image2023-5-29_10-8-8.png" width="600"  />
    </p>
    </div>
    <div class="section section-2" id="src-2949166_safe-id-aWQt5byC5bi4LeeUqOaIt-W8guW4uA">
        <h2 class="heading "><span>&#29992;&#25143;&#24322;&#24120;</span></h2>
<p   
>&#24322;&#24120;&#22914;&#26524;&#21457;&#29983;&#22312;&#20869;&#26680;&#23618;&#65292;&#22788;&#29702;&#36215;&#26469;&#27604;&#36739;&#31616;&#21333;&#65292;&#22240;&#20026;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#20063;&#22312;0&#29615;&#65292;&#19981;&#29992;&#20999;&#25442;&#22534;&#26632;&#65292;&#20294;&#26159;&#22914;&#26524;&#24322;&#24120;&#21457;&#29983;&#22312;3&#29615;&#65292;&#23601;&#24847;&#21619;&#30528;&#24517;&#39035;&#35201;&#20999;&#25442;&#22534;&#26632;&#65292;&#22238;&#21040;3&#29615;&#25191;&#34892;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#12290;&#36825;&#20010;<strong class=" ">&#22534;&#26632;&#20999;&#25442;&#30340;&#22788;&#29702;&#26041;&#24335;&#19982;&#29992;&#25143;APC&#30340;&#25191;&#34892;&#36807;&#31243;&#20960;&#20046;&#26159;&#19968;&#26679;&#30340;</strong>&#65292;&#24799;&#19968;&#30340;&#21306;&#21035;&#23601;&#26159;&#25191;&#34892;&#29992;&#25143;APC&#26102;&#36820;&#22238;3&#29615;&#21518;&#25191;&#34892;&#30340;&#20989;&#25968;&#26159;KiUserApcDispatcher&#65292;&#32780;&#24322;&#24120;&#22788;&#29702;&#26102;&#36820;&#22238;3&#29615;&#21518;<strong class=" ">&#25191;&#34892;&#30340;&#20989;&#25968;&#26159;KiUserExceptionDispatcher</strong>&#12290;&#22240;&#27492;&#26412;&#31456;&#33410;&#19981;&#20877;&#23545;&#22534;&#26632;&#30340;&#20999;&#25442;&#36827;&#34892;&#20102;&#35299;&#65292;&#21487;&#20197;&#33258;&#34892;&#22797;&#20064;&#19968;&#19979;&#29992;&#25143;APC&#25191;&#34892;&#36807;&#31243;&#30340;&#31508;&#35760;&#12290;</p>
<p   
>&#25105;&#20204;&#25509;&#30528;&#26469;&#30475;&#19968;&#19979;<strong class=" ">KiDispatchException&#20989;&#25968;</strong>&#26159;&#22914;&#20309;&#23545;&#29992;&#25143;&#31354;&#38388;&#30340;&#24322;&#24120;&#36827;&#34892;&#20998;&#21457;&#22788;&#29702;&#30340;&#65292;&#36824;&#26159;&#24320;&#22836;&#30340;&#37027;&#20960;&#27493;&#65306;&#20445;&#23384;Trap_Frame&#33267;_Context&#65292;&#21028;&#26029;&#20808;&#21069;&#27169;&#24335;&#22914;&#26524;&#20026;1&#21017;&#34920;&#31034;&#26469;&#24403;&#21069;&#24322;&#24120;&#26469;&#33258;&#29992;&#25143;&#31354;&#38388;&#65292;&#36339;&#36716;&#21040;&#23545;&#24212;&#20195;&#30721;&#27573;&#65292;&#25509;&#30528;&#21028;&#26029;&#26159;&#21542;&#26159;&#31532;&#19968;&#27425;&#20998;&#21457;&#65292;&#21028;&#26029;&#20869;&#26680;&#35843;&#35797;&#22120;&#65292;&#35843;&#29992;&#20869;&#26680;&#35843;&#35797;&#22120;...</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-29_14-17-2.png" alt="images/download/attachments/2949166/image2023-5-29_14-17-2.png" width="600"  />
    </p>
<p   
>&#36825;&#37324;&#19981;&#31649;&#26377;&#27809;&#26377;&#20869;&#26680;&#35843;&#35797;&#22120;&#65292;&#25110;&#20869;&#26680;&#35843;&#35797;&#22120;&#20989;&#25968;&#36820;&#22238;&#32467;&#26524;&#20026;0&#65292;&#37117;&#20250;<strong class=" ">&#36339;&#36716;&#25110;&#21521;&#19979;&#25191;&#34892;&#21040;&#21516;&#19968;&#22788;&#20195;&#30721;&#27573;</strong>&#65292;&#36825;&#37324;&#35843;&#29992;&#20102;&#19968;&#20010;&#20989;&#25968;_DbgkForwardException&#65292;&#23427;&#30340;&#20316;&#29992;&#26159;&#23558;&#24322;&#24120;&#21457;&#36865;&#32473;3&#29615;&#30340;&#35843;&#35797;&#22120;&#65292;<strong class=" ">&#22914;&#26524;&#36820;&#22238;&#38750;0&#21017;&#34920;&#31034;&#26377;3&#29615;&#35843;&#35797;&#22120;&#19988;&#22788;&#29702;&#20102;&#24322;&#24120;</strong>&#65292;&#23601;&#20250;&#36339;&#36716;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-29_14-20-36.png" alt="images/download/attachments/2949166/image2023-5-29_14-20-36.png" width="600"  />
    </p>
<p   
>&#21453;&#20043;&#65292;&#22914;&#26524;&#36820;&#22238;&#20026;0&#21017;&#34920;&#31034;&#27809;&#26377;&#22788;&#29702;&#35813;&#24322;&#24120;&#65292;&#32487;&#32493;&#21521;&#19979;&#25191;&#34892;&#23601;&#26159;&#20026;&#36820;&#22238;3&#29615;&#20570;&#20934;&#22791;&#65292;&#23558;Trap_Frame&#30340;&#20540;&#20462;&#25913;&#20026;&#36820;&#22238;3&#29615;&#26102;&#20505;&#30340;&#29615;&#22659;&#65292;&#35814;&#32454;&#30340;&#19981;&#20877;&#22810;&#35828;&#65292;<strong class=" ">&#20854;&#20013;&#26368;&#20026;&#37325;&#35201;&#30340;&#23601;&#26159;&#36820;&#22238;3&#29615;&#26102;&#30340;&#22320;&#22336;&#65292;&#21363;Trap_Frame._Eip&#65288;0x68&#20559;&#31227;&#20301;&#65289;</strong>&#65292;&#22914;&#19979;&#22270;&#20195;&#30721;&#25152;&#31034;&#65292;&#23558;_Eip&#20462;&#25913;&#20026;&#20102;KeUserExceptionDispatcher&#20989;&#25968;&#30340;&#22320;&#22336;&#65292;&#20063;&#23601;&#34920;&#31034;&#36820;&#22238;3&#29615;&#21518;&#23601;&#25191;&#34892;&#35813;&#20989;&#25968;&#12290;&#20294;&#26159;&#36825;&#37324;&#20462;&#25913;&#23436;Trap_Frame&#30340;&#20540;&#20043;&#21518;&#24182;&#27809;&#26377;&#36820;&#22238;3&#29615;&#65292;&#32780;&#26159;&#30452;&#25509;&#36339;&#36716;&#65292;KiDispatchException&#20989;&#25968;&#25191;&#34892;&#32467;&#26463;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-29_14-34-0.png" alt="images/download/attachments/2949166/image2023-5-29_14-34-0.png" width="500"  />
    </p>
<p   
>&#30001;&#20110;&#19981;&#21516;&#31867;&#22411;&#30340;&#24322;&#24120;&#65292;&#35843;&#29992;KiDispatcherException&#30340;&#20989;&#25968;&#19981;&#21516;&#65292;&#25152;&#20197;&#20250;&#24403;KiDispatcherException&#25191;&#34892;&#23436;&#21518;&#65292;&#20250;&#36820;&#22238;&#24403;&#30456;&#24212;&#30340;&#20989;&#25968;&#32487;&#32493;&#25191;&#34892;&#12290;&#22914;&#19979;&#22270;&#25152;&#31034;&#65292;&#22914;&#26524;&#26159;CPU&#24322;&#24120;&#65292;KiDispatcherException&#20989;&#25968;&#25191;&#34892;&#23436;&#25104;&#20043;&#21518;&#20250;&#36820;&#22238;&#21040;CommonDispatcherException&#20989;&#25968;&#20013;&#65292;&#24182;&#36890;&#36807;IRETD&#36820;&#22238;3&#29615;&#65288;<strong class=" ">CPU&#26159;&#36890;&#36807;&#20013;&#26029;&#38376;&#36827;&#30340;0&#29615;&#65292;&#22240;&#27492;&#29992;&#20013;&#26029;&#36820;&#22238;</strong>&#65289;&#65307;&#22914;&#26524;&#26159;&#27169;&#25311;&#24322;&#24120;&#65292;KiDispatcherException&#25191;&#34892;&#23436;&#25104;&#20043;&#21518;&#20250;&#36820;&#22238;&#21040;KiRaiseException&#20989;&#25968;&#20013;&#65292;&#24182;&#36890;&#36807;&#31995;&#32479;&#35843;&#29992;&#65288;KiServiceExit&#65289;&#36820;&#22238;3&#29615;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-29_14-40-47.png" alt="images/download/attachments/2949166/image2023-5-29_14-40-47.png" width="600"  />
    </p>
<p   
><strong class=" ">&#34429;&#28982;&#36820;&#22238;3&#29615;&#30340;&#26041;&#24335;&#19981;&#21516;&#65292;&#20294;&#21482;&#35201;&#26159;&#29992;&#25143;&#31354;&#38388;&#30340;&#24322;&#24120;</strong>&#65292;&#24403;&#32447;&#31243;&#20877;&#27425;&#22238;&#21040;3&#29615;&#26102;&#65292;&#25191;&#34892;&#30340;&#37117;&#26159;KiUserExceptionDispatcher&#12290;&#65288;KiUserExceptionDispatcher&#20989;&#25968;&#20250;&#22312;&#21518;&#32493;&#31456;&#33410;&#20013;&#20102;&#35299;&#65289;</p>
    </div>
    </div>
    <div class="section section-1" id="src-2949166_safe-id-aWQt5byC5bi4LVZFSA">
        <h1 class="heading "><span>VEH</span></h1>
<p   
>KiUserExceptionDispatcher&#20989;&#25968;&#23384;&#22312;&#19982;Ntdll.dll&#27169;&#22359;&#20013;&#65292;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;IDA&#25214;&#21040;&#24182;&#20998;&#26512;&#65292;&#35813;&#20989;&#25968;&#30340;&#20316;&#29992;&#24456;&#31616;&#21333;&#65292;&#39318;&#20808;&#35843;&#29992;RtlDispatchException&#20989;&#25968;&#65288;<strong class=" ">&#35813;&#20989;&#25968;&#20027;&#35201;&#29992;&#20110;&#26597;&#25214;&#24182;&#25191;&#34892;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;</strong>&#65289;&#65306;&#22914;&#26524;RtlDispatchException<strong class=" ">&#36820;&#22238;&#30495;&#21017;&#34920;&#31034;&#24322;&#24120;&#22788;&#29702;&#25104;&#21151;</strong>&#65292;&#37027;&#20040;&#21407;&#20195;&#30721;&#23601;&#38656;&#35201;&#20174;&#26032;&#30340;&#22320;&#26041;&#25110;&#21407;&#26469;&#30340;&#22320;&#26041;&#24320;&#22987;&#25191;&#34892;&#65292;&#22240;&#27492;&#38656;&#35201;&#35843;&#29992;ZwContinue&#20989;&#25968;&#20877;&#27425;&#36827;&#20837;0&#29615;&#65292;<strong class=" ">&#23558;&#20462;&#27491;&#21518;&#30340;_Context&#32467;&#26500;&#20307;&#32473;&#21040;Trap_Frame</strong>&#65292;&#36825;&#26679;&#23601;&#21487;&#20197;&#22312;&#32447;&#31243;&#20877;&#27425;&#36820;&#22238;3&#29615;&#26102;&#65292;&#20174;&#20462;&#27491;&#21518;&#30340;&#20301;&#32622;&#24320;&#22987;&#25191;&#34892;&#65307;&#22914;&#26524;RtlDispatchException&#36820;&#22238;&#20551;&#21017;&#34920;&#31034;&#24322;&#24120;&#27809;&#26377;&#34987;&#22788;&#29702;&#25110;&#27809;&#26377;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#65292;&#21017;<strong class=" ">&#35843;&#29992;ZwRaiseException&#20989;&#25968;&#36827;&#34892;&#20108;&#27425;&#24322;&#24120;&#20998;&#21457;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_11-5-13.png" alt="images/download/attachments/2949166/image2023-5-31_11-5-13.png" width="600"  />
    </p>
<p   
>RtlDispatchException&#26159;&#20010;&#24211;&#20989;&#25968;&#65292;&#22312;&#20869;&#26680;&#24322;&#24120;&#20998;&#21457;&#22788;&#29702;&#26102;&#29992;&#30340;&#20063;&#26159;&#36825;&#20010;&#20989;&#25968;&#65292;&#34429;&#28982;&#22312;&#29992;&#25143;&#24322;&#24120;&#20063;&#26159;&#22914;&#27492;&#65292;&#20294;&#23454;&#38469;&#36807;&#31243;&#26159;&#19981;&#19968;&#26679;&#30340;&#12290;</p>
<p   
>&#25105;&#20204;&#22312;&#20043;&#21069;&#20869;&#26680;&#24322;&#24120;&#20998;&#21457;&#23398;&#20064;&#20013;&#30693;&#36947;RtlDispatchException&#20989;&#25968;&#35843;&#29992;&#20102;RtlpGetRegistrationHead&#20989;&#25968;&#26469;&#26597;&#25214;&#19968;&#20010;&#24322;&#24120;&#38142;&#34920;&#65292;<strong class=" ">&#36825;&#20010;&#24322;&#24120;&#38142;&#34920;&#20063;&#21487;&#20197;&#31216;&#20043;&#20026;SEH&#38142;&#34920;</strong>&#65292;&#32780;&#22312;&#29992;&#25143;&#24322;&#24120;&#20998;&#21457;&#30340;RtlDispatchException&#20989;&#25968;&#20013;<strong class=" ">&#39318;&#20808;&#35843;&#29992;&#20102;RtlpExecuteHandlerForException&#20989;&#25968;</strong>&#26469;&#23547;&#25214;VEH&#38142;&#34920;&#65292;&#22914;&#26524;&#26377;&#30340;&#35805;&#21017;&#36941;&#21382;&#35813;&#38142;&#34920;&#25214;&#21040;&#23545;&#24212;&#30340;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#65292;&#22914;&#26524;&#27809;&#26377;&#21017;<strong class=" ">&#32487;&#32493;&#20351;&#29992;RtlpGetRegistrationHead&#20989;&#25968;</strong>&#26469;&#23547;&#25214;SEH&#38142;&#34920;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_11-37-27.png" alt="images/download/attachments/2949166/image2023-5-31_11-37-27.png" width="800"  />
    </p>
<p   
>SEH&#38142;&#34920;&#26159;&#19968;&#31181;&#23384;&#22312;&#22534;&#26632;&#20013;&#30340;<strong class=" ">&#23616;&#37096;&#38142;&#34920;</strong>&#65292;&#26412;&#31456;&#35201;&#23398;&#20064;&#30340;VEH&#38142;&#34920;&#32467;&#26500;&#19982;&#20043;&#30456;&#20284;&#65292;&#21482;&#19981;&#36807;<strong class=" ">VEH&#38142;&#34920;&#26159;&#20840;&#23616;&#38142;&#34920;</strong>&#12290;&#25105;&#20204;&#35201;&#24819;&#36890;&#36807;VEH&#26469;&#22788;&#29702;&#24322;&#24120;&#65292;&#35201;&#20808;&#21019;&#24314;&#22914;&#19979;&#22238;&#35843;&#20989;&#25968;&#26469;&#25509;&#25910;&#21644;&#22788;&#29702;&#24322;&#24120;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">LONG NTAPI VectoredHandler(</code></div>
<div class="line"><code class="plain">    PEXCEPTION_POINTERS ExceptionInfo</code></div>
<div class="line"><code class="plain">);</code></div>
</div>
    </div>
<p   
>&#35813;&#20989;&#25968;&#30340;&#21442;&#25968;ExceptionInfo&#20026;EXCEPTION_POINTERS&#32467;&#26500;&#20307;&#30340;&#25351;&#38024;&#65292;&#35813;&#32467;&#26500;&#20307;&#21450;&#20854;&#25104;&#21592;&#22914;&#19979;&#25152;&#31034;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">typedef struct _EXCEPTION_POINTERS {</code></div>
<div class="line"><code class="plain">    PEXCEPTION_RECORD ExceptionRecord;    </code><code class="comments">// 异常记录</code></div>
<div class="line"><code class="plain">    PCONTEXT ContextRecord;    </code><code class="comments">// 异常发生时的线程上下文环境</code></div>
<div class="line"><code class="plain">};</code></div>
</div>
    </div>
<p   
>&#22238;&#35843;&#20989;&#25968;VectoredHandler&#26377;&#20004;&#20010;&#36820;&#22238;&#20540;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">#define EXCEPTION_CONTINUE_SEARCH       </code><code class="value">0</code><code class="plain">  </code><code class="comments">// 异常未被处理，继续搜索</code></div>
<div class="line"><code class="plain">#define EXCEPTION_CONTINUE_EXECUTION    -</code><code class="value">1</code><code class="plain"> </code><code class="comments">// 异常处理完毕，恢复执行</code></div>
</div>
    </div>
<p   
>&#22238;&#35843;&#20989;&#25968;VectoredHandler&#21019;&#24314;&#20043;&#21518;&#65292;&#23601;&#21487;&#20197;&#23558;&#20854;&#36827;&#34892;&#27880;&#20876;&#65292;<strong class=" ">&#20063;&#23601;&#26159;&#28155;&#21152;&#21040;&#20840;&#23616;&#38142;&#34920;&#20013;</strong>&#65292;&#24403;&#36935;&#21040;&#23545;&#24212;&#30340;&#29992;&#25143;&#24322;&#24120;&#26102;&#65292;&#23601;&#20250;&#34987;&#26597;&#25214;&#24182;&#35843;&#29992;&#12290;&#27880;&#20876;&#22238;&#35843;&#20989;&#25968;&#30340;&#26684;&#24335;&#22914;&#19979;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">PVOID AddVectoredExceptionHandler(</code></div>
<div class="line"><code class="plain">    ULONG FirstHandler, </code><code class="comments">// 指定注册的回调函数被调用的顺序，该值为0表示希望最后被调用，为1表示希望最先被调用，若注册了多个回调函数，且所有的FirstHandler值都为1，那么最后注册的回调函数会被最先调用</code></div>
<div class="line"><code class="plain">    PVECTORED_EXCEPTION_HANDLER VectorerHandler </code><code class="comments">// 需要注册的回调函数</code></div>
<div class="line"><code class="plain">);</code></div>
</div>
    </div>
<p   
>&#22312;AddVectoredExceptionHandler&#20989;&#25968;&#20869;&#37096;&#65292;&#20250;&#20026;&#27599;&#20010;VEH&#20934;&#22791;&#22914;&#19979;&#19968;&#20010;&#32467;&#26500;&#20307;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">typedef struct _VEH_REGISTRATION{</code></div>
<div class="line"><code class="plain">    _VEH_REGISTRATION* next; </code><code class="comments">// 指向下一个VEH</code></div>
<div class="line"><code class="plain">    _VEH_REGISTRATION* prev; </code><code class="comments">// 指向上一个VEH</code></div>
<div class="line"><code class="plain">    PVECTORED_EXCEPTION_HANDLER pfnVeh; </code><code class="comments">// 指向当前VEH的回调函数</code></div>
<div class="line"><code class="plain">}VEH_REGISTRATION, *PVEH_REGISTRATION;</code></div>
</div>
    </div>
<p   
>&#24403;&#26377;&#22810;&#20010;VEH&#26102;&#65292;<strong class=" ">&#36825;&#20123;VEH&#30340;_VEH_REGISTRATION&#32467;&#26500;&#20307;&#20018;&#32852;&#32452;&#25104;&#19968;&#20010;&#21452;&#21521;&#38142;&#34920;</strong>&#12290;&#22312;Ntdll.dll&#27169;&#22359;&#20013;&#65292;&#20840;&#23616;&#21464;&#37327;RtlpCalloutEntryList&#25351;&#21521;&#35813;&#38142;&#34920;&#30340;&#38142;&#34920;&#22836;&#65288;&#22312;0&#29615;&#20013;&#65292;&#21017;&#26159;&#36890;&#36807;FS:[0]&#25214;&#21040;ExceptionList&#20877;&#25214;&#21040;SEH&#30340;&#38142;&#34920;&#22836;&#65289;&#12290;</p>
<p   
>&#24403;VEH&#22788;&#29702;&#24322;&#24120;&#32467;&#26463;&#20043;&#21518;&#65292;&#25105;&#20204;&#21487;&#20197;&#27880;&#38144;VEH&#65292;&#21363;&#22914;&#19979;&#36825;&#20010;&#20989;&#25968;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">PVOID RemoveVectoredExceptionHandler(</code></div>
<div class="line"><code class="plain">    PVECTORED_EXCEPTION_HANDLER VectorerHandler </code><code class="comments">// 注册的回调函数</code></div>
<div class="line"><code class="plain">);</code></div>
</div>
    </div>
<p   
>&#22312;&#26377;&#20102;&#20197;&#19978;&#22522;&#30784;&#30340;&#38138;&#22443;&#20043;&#21518;&#65292;&#25105;&#20204;&#21487;&#20197;&#32534;&#20889;&#22914;&#19979;&#20195;&#30721;&#26469;&#20351;&#29992;VEH&#22788;&#29702;&#24322;&#24120;&#65292;&#36825;&#27573;&#20195;&#30721;&#22823;&#33268;&#20998;&#20026;3&#37096;&#20998;&#65306;</p>
<ol class=" "><li class=" "><p   
>&#23450;&#20041;&#20102;&#25351;&#21521;AddVectorExceptionHandler&#20989;&#25968;&#30340;&#20989;&#25968;&#25351;&#38024;&#65292;<strong class=" ">&#22240;&#20026;VEH&#24322;&#24120;&#22788;&#29702;&#22312;XP&#20043;&#21069;&#30340;&#31995;&#32479;&#20013;&#24182;&#27809;&#26377;&#65292;&#20063;&#23601;&#19981;&#23384;&#22312;&#36825;&#20010;&#20989;&#25968;</strong>&#65292;&#22240;&#27492;&#20026;&#20102;&#20195;&#30721;&#20860;&#23481;&#24615;&#65292;&#25105;&#20204;&#19981;&#30452;&#25509;&#36890;&#36807;&#24211;&#35843;&#29992;&#65292;&#32780;&#26159;&#20197;&#21160;&#24577;&#21152;&#36733;DLL&#30340;&#26041;&#24335;&#26469;&#33719;&#21462;&#20989;&#25968;&#22320;&#22336;&#65292;&#28982;&#21518;&#29992;&#23450;&#20041;&#30340;&#20989;&#25968;&#25351;&#38024;&#25351;&#21521;&#23427;&#65292;&#20877;&#35843;&#29992;&#20989;&#25968;&#25351;&#38024;&#23601;&#21487;&#20197;&#20351;&#29992;&#30456;&#24212;&#21151;&#33021;&#20102;&#65307;</p>
</li><li class=" "><p   
>&#23450;&#20041;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;VectExcepHandler&#65292;&#26681;&#25454;&#20854;&#21442;&#25968;ExceptionInfo.ExceptionRecord.ExceptionCode&#26469;&#33719;&#21462;&#24322;&#24120;&#29366;&#24577;&#30721;&#65292;&#22914;&#26524;&#26159;&#38500;0&#24322;&#24120;&#21017;&#36890;&#36807;&#20004;&#31181;&#26041;&#24335;&#26469;&#22788;&#29702;&#24322;&#24120;&#65292;<strong class=" ">&#19968;&#26159;&#36890;&#36807;ExceptionInfo.ContextRecord.Eip&#26469;&#20462;&#25913;&#36820;&#22238;3&#29615;&#26102;&#30340;&#22320;&#22336;</strong>&#65292;&#20197;&#27492;&#26469;&#36339;&#36807;&#24322;&#24120;&#22788;&#29702;&#30340;&#20195;&#30721;&#65288;<strong class=" ">EIP+2&#26159;&#22240;&#20026;idiv ecx&#36825;&#20010;&#25351;&#20196;&#38271;&#24230;&#23601;&#26159;2</strong>&#65289;&#65292;<strong class=" ">&#20108;&#26159;&#36890;&#36807;ExceptionInfo.ContextRecord.Ecx&#26469;&#20462;&#25913;&#38500;&#25968;</strong>&#65292;&#20462;&#22797;&#24322;&#24120;&#30340;&#20195;&#30721;&#65307;</p>
</li><li class=" "><p   
>&#27880;&#20876;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#65292;&#24182;&#36890;&#36807;&#27719;&#32534;&#30340;&#26041;&#24335;&#26500;&#36896;&#38500;0&#24322;&#24120;&#65292;&#36825;&#37324;&#20063;&#23601;&#23558;EAX&#20316;&#20026;&#20102;&#38500;&#25968;&#65292;<strong class=" ">&#36825;&#26679;&#23601;&#21487;&#20197;&#35302;&#21457;&#24322;&#24120;</strong>&#65292;&#20174;&#32780;&#36827;&#20837;&#24322;&#24120;&#30340;&#22788;&#29702;&#12290;</p>
</li></ol>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">#include &lt;stdio.h&gt;</code></div>
<div class="line"><code class="plain">#include &lt;windows.h&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="comments">// 定义指向AddVectorExceptionHandler函数的函数指针</code></div>
<div class="line"><code class="plain">typedef PVOID(NTAPI *FnAddVectoredExceptionHandler)(ULONG, _EXCEPTION_POINTERS*); </code></div>
<div class="line"><code class="plain">FnAddVectoredExceptionHandler MyAddVectoredExceptionHandler;</code></div>
<div class="line"> </div>
<div class="line"><code class="comments">// 定义异常处理函数</code></div>
<div class="line"><code class="plain">LONG NTAPI VectExcepHandler(PEXCEPTION_POINTERS pExcepInfo) </code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    MessageBox(NULL,</code><code class="string">"VEH异常处理函数执行了..."</code><code class="plain">,</code><code class="string">"VEH异常"</code><code class="plain">,MB_OK);</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    </code><code class="comments">// 除0异常</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> (pExcepInfo-&gt;ExceptionRecord-&gt;ExceptionCode == </code><code class="value">0xC0000094</code><code class="plain">) </code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// 修改发生异常时的EIP</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// pExcepInfo-&gt;ContextRecord-&gt;Eip = pExcepInfo-&gt;ContextRecord-&gt;Eip + 2;</code></div>
<div class="line"><code class="plain">        </code></div>
<div class="line"><code class="plain">        </code><code class="comments">// 修改发生异常时的ECX</code></div>
<div class="line"><code class="plain">        pExcepInfo-&gt;ContextRecord-&gt;Ecx = </code><code class="value">1</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        </code></div>
<div class="line"><code class="plain">        </code><code class="comments">// 此处返回表示异常已处理</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> EXCEPTION_CONTINUE_EXECUTION;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// 此处返回表示异常未处理</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> EXCEPTION_CONTINUE_SEARCH;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"> </div>
<div class="line"><code class="comments">// 主函数</code></div>
<div class="line"><code class="keyword">int</code><code class="plain"> main()</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// 动态获取AddVectoredExceptionHandler函数地址，并将异常处理函数挂入VEH链表</code></div>
<div class="line"><code class="plain">    HMODULE hModule = GetModuleHandle(</code><code class="string">"Kernel32.dll"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    MyAddVectoredExceptionHandler = (FnAddVectoredExceptionHandler)::GetProcAddress(hModule,</code><code class="string">"AddVectoredExceptionHandler"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    </code><code class="comments">// 注册</code></div>
<div class="line"><code class="plain">    MyAddVectoredExceptionHandler(</code><code class="value">0</code><code class="plain">, (_EXCEPTION_POINTERS *)&amp;VectExcepHandler);</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    </code><code class="comments">// 构造除0异常</code></div>
<div class="line"><code class="plain">    _asm</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        xor edx, edx</code></div>
<div class="line"><code class="plain">        xor ecx, ecx</code></div>
<div class="line"><code class="plain">        mov eax, </code><code class="value">100</code></div>
<div class="line"><code class="plain">        idiv ecx</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    printf(</code><code class="string">"Running ... "</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    getchar();</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> </code><code class="value">0</code><code class="plain">;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-2949166_safe-id-aWQt5byC5bi4LVNFSA">
        <h1 class="heading "><span>SEH</span></h1>
    <div class="section section-2" id="src-2949166_safe-id-aWQt5byC5bi4LeWOn-eUn1NFSA">
        <h2 class="heading "><span>&#21407;&#29983;SEH</span></h2>
<p   
>&#22914;&#26524;&#35843;&#29992;RtlDispatchException&#20989;&#25968;&#25214;&#19981;&#21040;VEH&#38142;&#34920;&#65292;&#21017;&#20250;&#21435;&#23547;&#25214;SEH&#38142;&#34920;&#65292;SEH&#38142;&#34920;&#26159;&#19968;&#20010;&#23616;&#37096;&#38142;&#34920;&#65292;&#23384;&#20648;&#22312;&#24403;&#21069;&#32447;&#31243;&#30340;&#26632;&#20013;&#65292;<strong class=" ">&#22240;&#27492;&#19981;&#21516;&#30340;&#32447;&#31243;&#35201;&#36890;&#36807;SEH&#26469;&#22788;&#29702;&#24322;&#24120;&#37117;&#38656;&#35201;&#22312;&#33258;&#24049;&#30340;&#22534;&#26632;&#20013;&#23384;&#25918;</strong>&#12290;</p>
<p   
>SEH&#38142;&#34920;&#30340;&#26684;&#24335;&#22914;&#19979;&#25152;&#31034;&#65292;&#23427;&#26159;&#19968;&#20010;&#21333;&#21521;&#38142;&#34920;&#65292;&#27599;&#20010;&#25104;&#21592;&#20013;&#21253;&#21547;&#20102;&#20004;&#20010;&#25104;&#21592;&#65292;&#21363;Next&#65288;&#19979;&#19968;&#20010;SEH&#65289;&#21644;Handler&#65288;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#65289;&#12290;&#26080;&#35770;&#26159;&#22312;&#20869;&#26680;&#36824;&#26159;&#29992;&#25143;&#31354;&#38388;&#65292;&#25105;&#20204;&#37117;&#21487;&#20197;<strong class=" ">&#36890;&#36807;FS:[0]&#26469;&#25214;&#21040;&#35813;&#38142;&#34920;&#22836;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_16-29-58.png" alt="images/download/attachments/2949166/image2023-5-31_16-29-58.png" width="400"  />
    </p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_16-38-14.png" alt="images/download/attachments/2949166/image2023-5-31_16-38-14.png" width="400"  />
    </p>
<p   
>SEH&#19982;VEH&#19981;&#21516;&#30340;&#26159;&#65292;&#21069;&#32773;&#27809;&#27861;&#20351;&#29992;&#20989;&#25968;&#30340;&#26041;&#24335;&#21435;&#27880;&#20876;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#65292;&#38656;&#35201;&#25105;&#20204;<strong class=" ">&#25163;&#21160;&#30340;&#21521;&#26632;&#20013;&#22635;&#20805;&#65292;&#28982;&#21518;&#23558;FS:[0]&#25351;&#21521;&#36825;&#22359;&#26632;&#22320;&#22336;</strong>&#12290;&#36825;&#37324;&#25105;&#20204;&#21487;&#20197;&#33258;&#24049;&#23450;&#20041;&#19968;&#20010;SEH&#32467;&#26500;&#20307;&#65292;&#20294;&#19968;&#23450;&#38656;&#35201;&#21253;&#21547;2&#20010;&#25104;&#21592;&#65292;&#21363;Next&#12289;Handler&#65292;&#22914;&#19979;&#25152;&#31034;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">struct _MY_EXCEPTION  </code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    struct _MY_EXCEPTION *Next;</code></div>
<div class="line"><code class="plain">    DWORD Handler;</code></div>
<div class="line"><code class="plain">};</code></div>
</div>
    </div>
<p   
>&#25105;&#20204;&#25509;&#30528;&#26469;&#20998;&#26512;&#19968;&#19979;RtlDispatchException&#20989;&#25968;&#65292;&#20197;&#39564;&#35777;&#19978;&#36848;&#30340;&#19968;&#20123;&#35266;&#28857;&#12290;&#22914;&#19979;&#22270;&#25152;&#31034;&#22312;&#35813;&#20989;&#25968;&#20869;&#25214;&#19981;&#21040;VEH&#38142;&#34920;&#21518;&#65292;&#20250;&#21435;&#35843;&#29992;&#20004;&#20010;&#20989;&#25968;&#12290;</p>
<p   
>&#31532;&#19968;&#20010;&#20989;&#25968;RtlpGetStackLimits&#21462;&#20102;FS:[8]&#21644;FS:[4]&#30340;&#20540;&#65292;<strong class=" ">&#21363;_TEB._NT_TIB.StackBase&#21644;_TEB._NT_TIB.StackLimit</strong>&#65292;&#36825;&#20004;&#20010;&#20540;&#23601;&#26159;&#26632;&#30340;&#22522;&#22336;&#21644;&#26632;&#30340;&#22823;&#23567;&#65292;<strong class=" ">&#21462;&#36825;&#20004;&#20010;&#20540;&#30340;&#30446;&#30340;&#23601;&#26159;&#20026;&#20102;&#26816;&#26597;SEH&#38142;&#34920;&#26159;&#21542;&#23646;&#20110;&#24403;&#21069;&#32447;&#31243;&#30340;&#26632;&#20013;</strong>&#12290;</p>
<p   
>&#31532;&#20108;&#20010;&#20989;&#25968;RtlpGetRegistrationHead&#21462;FS:[0]&#30340;&#20540;&#65292;&#21363;<strong class=" ">_TEB._NT_TIB.ExceptionList</strong>&#65292;&#20063;&#23601;&#26159;SEH&#38142;&#34920;&#22836;&#22320;&#22336;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_16-55-46.png" alt="images/download/attachments/2949166/image2023-5-31_16-55-46.png" width="800"  />
    </p>
<p   
>RtlDispatchException&#20989;&#25968;&#20877;&#24448;&#19979;&#36208;&#65292;&#25105;&#20204;&#30475;&#35265;&#23427;&#35843;&#29992;&#20102;RtlIsValidHandler&#20989;&#25968;&#65292;&#29992;&#20110;<strong class=" ">&#39564;&#35777;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#26159;&#21542;&#26377;&#25928;</strong>&#65292;&#25509;&#30528;&#35843;&#29992;<strong class=" ">RtlpExecuteHandlerForException&#20989;&#25968;</strong>&#65292;&#29992;&#20110;&#35843;&#29992;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#65292;&#22240;&#27492;&#25105;&#20204;&#30340;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#24182;&#19981;&#21487;&#20197;&#23436;&#20840;&#33258;&#23450;&#20041;&#65292;&#32780;&#26159;<strong class=" ">&#38656;&#35201;&#36981;&#24490;&#20854;&#25152;&#33021;&#25191;&#34892;&#30340;&#26684;&#24335;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_17-2-26.png" alt="images/download/attachments/2949166/image2023-5-31_17-2-26.png" width="600"  />
    </p>
<p   
>SEH&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#30340;&#26684;&#24335;&#22914;&#19979;&#65292;&#23427;&#19968;&#20849;&#26377;4&#20010;&#21442;&#25968;&#65292;&#25105;&#20204;&#21482;&#38656;&#35201;&#20102;&#35299;&#21069;&#19977;&#20010;&#21442;&#25968;&#30340;&#21547;&#20041;&#21363;&#21487;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">EXCEPTION_DISPOSITION _cdecl MyEexceptionHandler</code></div>
<div class="line"><code class="plain">(</code></div>
<div class="line"><code class="plain">    struct _EXCEPTION_RECORD *ExceptionRecord, </code><code class="comments">// 异常记录结构体</code></div>
<div class="line"><code class="plain">    PVOID EstablisherFrame, </code><code class="comments">// SEH结构体地址</code></div>
<div class="line"><code class="plain">    struct _CONTEXT *ContextRecord, </code><code class="comments">// 存储异常发生时的上下文环境</code></div>
<div class="line"><code class="plain">    PVOID DispatcherContext</code></div>
<div class="line"><code class="plain">)</code></div>
</div>
    </div>
<p   
>&#37027;&#20040;&#26377;&#20102;&#36825;&#20123;&#22522;&#30784;&#30340;&#38138;&#22443;&#20043;&#21518;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#32534;&#20889;&#20195;&#30721;&#26469;&#23454;&#29616;SEH&#24322;&#24120;&#22788;&#29702;&#65292;&#36825;&#27573;&#20195;&#30721;&#19982;VEH&#24322;&#24120;&#22788;&#29702;&#24046;&#19981;&#22810;&#65292;&#21807;&#19968;&#30340;&#21306;&#21035;&#22312;&#20110;&#22312;&#25105;&#20204;&#23558;FS:[0]&#25351;&#21521;SEH&#32467;&#26500;&#20307;&#20043;&#21069;<strong class=" ">&#38656;&#35201;&#20808;&#20445;&#23384;&#21407;FS:[0]&#30340;&#20540;</strong>&#65292;&#28982;&#21518;&#22312;&#32467;&#26500;&#20307;&#30340;Next&#36171;&#20540;&#26102;<strong class=" ">&#23558;&#21407;FS:[0]&#30340;&#20540;&#20889;&#20837;</strong>&#65292;&#22240;&#20026;&#21487;&#33021;&#22312;&#21407;SEH&#38142;&#34920;&#20013;&#26159;&#26377;&#20869;&#23481;&#30340;&#65292;&#26368;&#21518;&#22312;SEH&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#32467;&#26463;&#65292;<strong class=" ">&#23558;FS:[0]&#30340;&#20540;&#36824;&#21407;</strong>&#12290;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">#include &lt;stdio.h&gt;</code></div>
<div class="line"><code class="plain">#include &lt;windows.h&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">struct _MY_EXCEPTION  </code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    struct _MY_EXCEPTION *Next;</code></div>
<div class="line"><code class="plain">    DWORD Handler;</code></div>
<div class="line"><code class="plain">};</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">EXCEPTION_DISPOSITION _cdecl MyEexceptionHandler</code></div>
<div class="line"><code class="plain">(</code></div>
<div class="line"><code class="plain">    struct _EXCEPTION_RECORD *ExceptionRecord, </code><code class="comments">// 异常记录结构体</code></div>
<div class="line"><code class="plain">    PVOID EstablisherFrame, </code><code class="comments">// SEH结构体地址</code></div>
<div class="line"><code class="plain">    struct _CONTEXT *ContextRecord, </code><code class="comments">// 存储异常发生时的上下文环境</code></div>
<div class="line"><code class="plain">    PVOID DispatcherContext</code></div>
<div class="line"><code class="plain">)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    MessageBox(NULL, </code><code class="string">"SEH异常处理函数执行了..."</code><code class="plain">, </code><code class="string">"SEH"</code><code class="plain">, MB_OK);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> (ExceptionRecord-&gt;ExceptionCode == </code><code class="value">0xC0000094</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// ContextRecord-&gt;Eip = ContextRecord-&gt;Eip + 2;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        ContextRecord-&gt;Ecx = </code><code class="value">1</code><code class="plain">;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> ExceptionContinueExecution;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> ExceptionContinueSearch;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">int</code><code class="plain"> main()</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    DWORD tmpData;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// 必须在当前线程栈中</code></div>
<div class="line"><code class="plain">    _MY_EXCEPTION Exception;</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    </code><code class="comments">// FS:[0] -&gt; Exception</code></div>
<div class="line"><code class="plain">    _asm</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        mov eax, fs:[</code><code class="value">0</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        mov tmpData, eax </code><code class="comments">// 保存原FS:[0]</code></div>
<div class="line"><code class="plain">        lea ecx, Exception</code></div>
<div class="line"><code class="plain">        mov fs:[</code><code class="value">0</code><code class="plain">], ecx</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// 成员赋值</code></div>
<div class="line"><code class="plain">    Exception.Next = ( _MY_EXCEPTION *)tmpData;</code></div>
<div class="line"><code class="plain">    Exception.Handler = (DWORD)&amp;MyEexceptionHandler;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// 构造除0异常</code></div>
<div class="line"><code class="plain">    _asm</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        xor edx, edx</code></div>
<div class="line"><code class="plain">        xor ecx, ecx</code></div>
<div class="line"><code class="plain">        mov eax, </code><code class="value">1</code></div>
<div class="line"><code class="plain">        idiv ecx</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// 摘除刚插入的SEH，还原FS:[0]</code></div>
<div class="line"><code class="plain">    _asm</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        mov eax, tmpData</code></div>
<div class="line"><code class="plain">        mov fs:[</code><code class="value">0</code><code class="plain">], eax</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    printf(</code><code class="string">"Running ... "</code><code class="plain">);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    getchar();</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> </code><code class="value">0</code><code class="plain">;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-2949166_safe-id-aWQt5byC5bi4Lee8luivkeWZqOaJqeWxlVNFSA">
        <h2 class="heading "><span>&#32534;&#35793;&#22120;&#25193;&#23637;SEH</span></h2>
    <div class="section section-3" id="src-2949166_safe-id-aWQt5byC5bi4LV90cnlfZXhjZXB0">
        <h3 class="heading "><span>_try_except</span></h3>
<p   
>&#25105;&#20204;&#22312;&#19978;&#19968;&#31456;&#23398;&#20064;&#30340;&#26159;Windows&#33258;&#24102;&#30340;&#21407;&#29983;SEH&#65292;&#38500;&#27492;&#20043;&#22806;&#23454;&#38469;&#19978;&#32534;&#35793;&#22120;&#36824;&#21478;&#22806;&#25193;&#23637;&#20102;SEH&#65292;&#36825;&#26159;&#22240;&#20026;&#20351;&#29992;&#21407;&#29983;SEH&#23454;&#38469;&#19978;&#38750;&#24120;&#40635;&#28902;&#65292;&#38656;&#35201;&#33258;&#24049;&#26500;&#24314;&#32467;&#26500;&#20307;&#12289;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#12289;&#20889;&#20837;FS:[0]&#31561;&#31561;&#25805;&#20316;&#12290;</p>
<p   
>&#22312;VC6&#32534;&#35793;&#22120;&#19979;&#65292;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#22914;&#19979;&#26684;&#24335;&#30340;&#20195;&#30721;&#26469;&#22788;&#29702;SEH&#24322;&#24120;&#65292;&#21363;<u class=" "><strong class=" ">_try{...})except(...){...}</strong></u>&#26684;&#24335;&#65292;&#20351;&#29992;&#36825;&#31181;&#26684;&#24335;&#32534;&#20889;&#20195;&#30721;&#21518;&#65292;<strong class=" ">&#32534;&#35793;&#22120;&#20250;&#22312;&#32534;&#35793;&#26102;&#24110;&#25105;&#20204;&#36716;&#25442;</strong>&#65292;&#20351;&#24471;&#26368;&#32456;&#20195;&#30721;&#33021;&#22815;&#23454;&#29616;&#25346;&#20837;&#38142;&#34920;&#12289;&#24322;&#24120;&#36807;&#28388;&#12289;&#24322;&#24120;&#22788;&#29702;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_19-14-59.png" alt="images/download/attachments/2949166/image2023-5-31_19-14-59.png" width="400"  />
    </p>
<p   
>&#22312;&#36807;&#28388;&#34920;&#36798;&#24335;&#37096;&#20998;&#65292;&#25105;&#20204;&#21487;&#20197;&#30452;&#25509;&#20889;&#24120;&#37327;&#20540;&#65292;&#20063;&#21487;&#20197;&#20889;&#34920;&#36798;&#24335;&#25110;&#35843;&#29992;&#30340;&#20989;&#25968;&#65292;&#20294;&#26080;&#35770;&#20160;&#20040;&#26041;&#24335;&#65292;<strong class=" ">&#36825;&#37324;&#26368;&#32456;&#30340;&#20540;&#21482;&#33021;&#20026;0&#12289;1&#12289;-1</strong>&#65292;&#23427;&#20204;&#30340;&#21547;&#20041;&#22914;&#19979;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">#define EXCEPTION_EXECUTE_HANDLER </code><code class="value">1</code><code class="plain"> </code><code class="comments">// 执行except内的代码</code></div>
<div class="line"><code class="plain">#define EXCEPTION_CONTINUE_SEARCH </code><code class="value">0</code><code class="plain"> </code><code class="comments">// 寻找下一个异常处理函数</code></div>
<div class="line"><code class="plain">#define EXCEPTION_CONTINUE_EXECUTION -</code><code class="value">1</code><code class="plain"> </code><code class="comments">// 返回至出错位置重新执行</code></div>
</div>
    </div>
<p   
>&#19977;&#31181;&#19981;&#21516;&#39118;&#26684;&#30340;&#34920;&#36798;&#24335;&#31034;&#20363;&#20195;&#30721;&#22914;&#19979;&#65292;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#24403;&#31616;&#21333;&#30340;&#24322;&#24120;&#36807;&#28388;&#21487;&#20197;&#30452;&#25509;&#20889;&#24120;&#37327;&#65292;&#22797;&#26434;&#19968;&#20123;&#30340;&#20351;&#29992;&#19977;&#20803;&#34920;&#36798;&#24335;&#65292;&#20877;&#22797;&#26434;&#19968;&#20123;&#30340;&#21487;&#20197;&#20351;&#29992;&#20989;&#25968;&#30340;&#26041;&#24335;&#65292;&#24182;&#19988;&#25105;&#20204;&#21487;&#20197;<strong class=" ">&#20351;&#29992;GetExceptionCode&#12289;GetExceptionInformation&#20989;&#25968;&#26469;&#33719;&#21462;&#24322;&#24120;&#29366;&#24577;&#30721;&#12289;&#24322;&#24120;&#30456;&#20851;&#20449;&#24687;</strong>&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">#include &lt;stdio.h&gt;</code></div>
<div class="line"><code class="plain">#include &lt;windows.h&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">int</code><code class="plain"> getFilterCode(PEXCEPTION_POINTERS pExcepInfo)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    pExcepInfo-&gt;ContextRecord-&gt;Ecx = </code><code class="value">1</code><code class="plain">;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> EXCEPTION_CONTINUE_EXECUTION;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">int</code><code class="plain"> main()</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    _try</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        _asm</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            xor edx, edx</code></div>
<div class="line"><code class="plain">            xor ecx, ecx</code></div>
<div class="line"><code class="plain">            mov eax, </code><code class="value">1</code></div>
<div class="line"><code class="plain">            idiv ecx</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// _except(EXCEPTION_EXECUTE_HANDLER)</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// _except(GetExceptionCode() == 0xC0000094 ? EXCEPTION_EXECUTE_HANDLER : EXCEPTION_CONTINUE_SEARCH)</code></div>
<div class="line"><code class="plain">    _except(getFilterCode(GetExceptionInformation()))</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        printf(</code><code class="string">"Processing ..."</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    printf(</code><code class="string">"Running ..."</code><code class="plain">);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    getchar();</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> </code><code class="value">0</code><code class="plain">;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#21453;&#27719;&#32534;&#26469;&#30475;&#19968;&#19979;&#20351;&#29992;_try_except&#30340;&#32972;&#21518;&#21040;&#24213;&#24178;&#20102;&#20160;&#20040;&#65292;&#22914;&#19979;&#22270;&#25152;&#31034;&#65292;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#19982;&#25105;&#20204;&#25163;&#21160;&#25346;&#20837;&#38142;&#34920;&#31867;&#20284;&#65292;&#20445;&#23384;&#21407;FS:[0]&#65292;&#23558;&#20854;&#20316;&#20026;&#19979;&#19968;SEH&#32467;&#26500;&#20307;&#22320;&#22336;&#65292;&#28982;&#21518;&#23558;FS:[0]&#25351;&#21521;&#24403;&#21069;SEH&#32467;&#26500;&#20307;&#30340;&#22320;&#22336;&#65292;&#24182;&#19988;&#22312;&#36825;&#37324;&#30340;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#20026;_except_handler3&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_20-31-14.png" alt="images/download/attachments/2949166/image2023-5-31_20-31-14.png" width="600"  />
    </p>
<p   
>&#37027;&#20040;&#20986;&#29616;&#23884;&#22871;_try_except&#20351;&#29992;&#26102;&#20250;&#24590;&#20040;&#26679;&#21602;&#65292;&#25353;&#29031;&#27491;&#24120;&#36923;&#36753;&#26469;&#24819;&#65292;&#32943;&#23450;&#20250;&#20986;&#29616;&#37325;&#22797;&#25346;&#20837;&#38142;&#34920;&#30340;&#25805;&#20316;&#65288;&#35774;&#32622;&#38142;&#34920;&#22836;&#65289;&#65292;&#20294;&#26159;&#25105;&#20204;&#36890;&#36807;&#21453;&#27719;&#32534;&#30475;&#35265;&#65292;&#32534;&#35793;&#22120;&#22788;&#29702;<strong class=" ">&#23454;&#38469;&#19978;&#21482;&#25346;&#20837;&#20102;&#19968;&#27425;</strong>&#65292;&#24182;&#19988;&#20173;&#28982;&#21482;&#26377;&#19968;&#20010;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;_except_handler3&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_20-40-47.png" alt="images/download/attachments/2949166/image2023-5-31_20-40-47.png" width="600"  />
    </p>
<p   
>&#33021;&#36825;&#26679;&#23454;&#29616;&#26159;&#22240;&#20026;&#32534;&#35793;&#22120;&#25193;&#23637;&#20102;SEH&#32467;&#26500;&#20307;&#65292;&#20174;&#21407;&#20808;&#21482;&#26377;2&#20010;&#25104;&#21592;&#30340;&#32467;&#26500;&#20307;&#21464;&#25104;&#20102;5&#20010;&#25104;&#21592;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">struct _EXCEPTION_REGISTRATION{</code></div>
<div class="line"><code class="plain">    struct _EXCEPTION_REGISTRATION *prev;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">void</code><code class="plain"> (*handler)(PEXCEPTION_RECORD, PEXCEPTION_REGISTRATION, PCONTEXT, PEXCEPTION_RECORD);</code></div>
<div class="line"><code class="plain">    struct scopetable_entry *scopetable;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">int</code><code class="plain"> trylevel;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">int</code><code class="plain"> _ebp;</code></div>
<div class="line"><code class="plain"> };</code></div>
</div>
    </div>
<p   
>&#22534;&#26632;&#23545;&#24212;&#20063;&#23601;&#21457;&#29983;&#20102;&#21464;&#21270;&#65292;&#22914;&#19979;&#22270;&#25152;&#31034;&#20026;&#22534;&#26632;&#23545;&#24212;&#32467;&#26500;&#20307;&#25104;&#21592;&#65306;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-5-31_20-56-58.png" alt="images/download/attachments/2949166/image2023-5-31_20-56-58.png" width="600"  />
    </p>
<p   
>&#25105;&#20204;&#26469;&#30475;&#19968;&#19979;&#20877;&#21407;&#26377;SEH&#32467;&#26500;&#20307;&#19978;&#26032;&#22686;&#30340;3&#20010;&#25104;&#21592;&#65292;&#39318;&#20808;&#26159;_ebp&#36825;&#20010;&#25104;&#21592;&#23601;&#26159;&#26632;&#24213;&#65292;<strong class=" ">&#20854;&#27425;&#26159;scopetable</strong>&#65292;&#23427;&#26159;&#19968;&#20010;&#32467;&#26500;&#20307;&#25351;&#38024;&#65292;&#25351;&#21521;&#20102;scopetable_entry&#32467;&#26500;&#20307;&#65292;&#35813;&#32467;&#26500;&#20307;&#21450;&#25104;&#21592;&#21547;&#20041;&#22914;&#19979;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">struct scopetable_entry</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    DWORD previousTryLevel </code><code class="comments">// 上一个_try_except程序块编号 </code></div>
<div class="line"><code class="plain">    PDWRD lpfnFilter </code><code class="comments">// 过滤函数的起始地址</code></div>
<div class="line"><code class="plain">    PDWRD lpfnHandler </code><code class="comments">// 异常处理程序的地址        </code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>&#25105;&#20204;&#21487;&#20197;&#20855;&#20307;&#26469;&#35843;&#35797;&#30475;&#19968;&#19979;&#35813;&#32467;&#26500;&#20307;&#65292;&#22914;&#19979;&#25152;&#31034;&#25105;&#20204;&#20351;&#29992;&#20102;1&#20010;&#21333;&#29420;&#30340;_try_except&#20195;&#30721;&#22359;&#21644;1&#20010;&#23884;&#22871;&#30340;_try_except&#20195;&#30721;&#22359;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="keyword">void</code><code class="plain"> test()</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    _try</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    _except(</code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        printf(</code><code class="value">123</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    _try</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        _try</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        _except(</code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            printf(</code><code class="value">456</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    _except(</code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        printf(</code><code class="value">789</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>&#36890;&#36807;&#21453;&#27719;&#32534;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#65292;&#24403;&#26377;3&#20010;_try_except&#31243;&#24207;&#22359;&#26102;&#23601;&#20250;&#26377;&#19977;&#20010;scopetable_entry&#32467;&#26500;&#20307;&#65292;&#23427;&#20204;&#26159;&#23545;&#24212;&#20851;&#31995;&#12290;&#25104;&#21592;<strong class=" ">previousTryLevel&#25351;&#21521;&#19978;&#19968;&#20010;_try_except&#31243;&#24207;&#22359;&#30340;&#32534;&#21495;</strong>&#65292;<strong class=" ">&#19981;&#22312;&#23884;&#22871;&#37324;&#23601;&#27809;&#26377;&#19978;&#19968;&#23618;&#65292;&#22240;&#27492;&#20540;&#20026;-1</strong>&#65292;&#36825;&#37324;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#26377;&#20004;&#20010;&#32467;&#26500;&#20307;&#30340;&#25104;&#21592;previousTryLevel&#20540;&#22343;&#20026;-1&#65292;&#31532;&#19977;&#20010;&#32467;&#26500;&#20307;&#30340;previousTryLevel&#20540;&#20026;1&#65292;&#26159;&#22240;&#20026;&#23427;&#26159;&#22312;&#23884;&#22871;_try_except&#31243;&#24207;&#22359;&#20013;&#65292;&#19978;&#38754;&#30830;&#23454;&#26377;&#19968;&#23618;_try_except&#31243;&#24207;&#22359;&#65292;<strong class=" ">&#22240;&#27492;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#36825;&#20010;&#20540;&#26469;&#21028;&#26029;&#24403;&#21069;&#22312;&#31532;&#20960;&#23618;&#23884;&#22871;&#20013;</strong>&#65307;&#25104;&#21592;<strong class=" ">lpfnFilter&#25351;&#21521;&#36807;&#28388;&#20989;&#25968;&#30340;&#39318;&#22320;&#22336;</strong>&#65292;&#22914;&#22270;&#25152;&#31034;<strong class=" ">&#20063;&#23601;&#26159;&#25105;&#20204;&#30340;_except(&#36807;&#28388;&#34920;&#36798;&#24335;)&#37027;&#20010;&#22320;&#22336;</strong>&#65292;&#36890;&#36807;&#36820;&#27719;&#32534;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#36825;&#26159;&#26377;RET&#36820;&#22238;&#32467;&#26524;&#30340;&#65292;&#25152;&#20197;&#24403;&#24322;&#24120;&#21457;&#29983;&#26102;&#65292;&#20195;&#30721;&#20250;&#32463;&#36807;&#22810;&#27425;&#36339;&#36716;&#21644;&#36820;&#22238;&#65307;&#25104;&#21592;<strong class=" ">lpfnHandler&#25351;&#21521;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#30340;&#39318;&#22320;&#22336;</strong>&#65292;&#20063;&#23601;&#26159;<strong class=" ">_except&#31243;&#24207;&#22359;&#20869;&#30340;&#24322;&#24120;&#22788;&#29702;&#20195;&#30721;&#65292;&#21363;&#19979;&#22270;&#25152;&#31034;&#20013;&#30340;printf&#20989;&#25968;&#37096;&#20998;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-1_11-8-51.png" alt="images/download/attachments/2949166/image2023-6-1_11-8-51.png" width="600"  />
    </p>
<p   
>&#20102;&#35299;&#20102;scopetable&#21450;&#20854;&#23545;&#24212;&#32467;&#26500;&#20307;&#30340;&#25104;&#21592;&#20043;&#21518;&#65292;&#25105;&#20204;&#20877;&#26469;&#30475;&#19968;&#19979;trylevel&#25104;&#21592;&#65292;&#35813;&#25104;&#21592;&#34920;&#31034;&#24403;&#21069;&#22312;&#21738;&#20010;_try_except&#31243;&#24207;&#22359;&#65292;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#22914;&#19979;&#36825;&#27573;&#20195;&#30721;&#26469;&#30475;&#19968;&#19979;&#35813;&#20540;&#30340;&#21464;&#21270;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="keyword">void</code><code class="plain"> test()</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    _try</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        _try</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        _except(</code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            printf(</code><code class="string">"123"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    _except(</code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        printf(</code><code class="string">"456"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    _try</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        _try</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        _except(</code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            printf(</code><code class="string">"789"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    _except(</code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        printf(</code><code class="string">"012"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>&#25105;&#20204;&#25509;&#30528;&#26469;&#30475;&#36825;&#27573;&#21453;&#27719;&#32534;&#65292;&#39318;&#20808;&#23558;EBP&#21387;&#20837;&#25193;&#23637;&#32467;&#26500;&#20307;&#65292;&#28982;&#21518;&#23558;EBP&#25552;&#21319;&#33267;ESP&#20301;&#32622;&#65292;&#20877;&#21387;&#20837;trylevel&#65292;<strong class=" ">&#21021;&#22987;&#20540;&#23601;&#26159;-1&#65292;&#25105;&#20204;&#20063;&#21487;&#20197;&#36890;&#36807;[EBP-4]&#26469;&#25214;&#21040;&#35813;&#20540;</strong>&#65292;&#25509;&#30528;&#25105;&#20204;&#20250;&#21457;&#29616;&#27599;&#20010;_try&#37117;&#20250;&#26377;&#19968;&#27425;&#30340;trylevel&#30340;&#20462;&#25913;&#65292;&#26681;&#25454;&#25968;&#20540;&#26469;&#30475;&#36825;&#23601;&#20687;&#26159;&#19968;&#20849;&#32034;&#24341;&#65292;&#31532;&#19968;&#20010;_try_except&#22359;trylevel&#20540;&#20026;0&#65292;&#31532;&#20108;&#20010;&#21017;&#20540;&#20026;1&#65292;&#20197;&#27492;&#31867;&#25512;&#65292;&#22914;&#26524;&#26159;&#23884;&#22871;&#30340;_try_except&#22359;&#21017;&#20869;&#23884;&#30340;&#22359;&#25351;&#21521;&#32467;&#26463;&#20043;&#21518;&#20250;&#23558;&#35813;trylevel&#20540;&#20462;&#25913;&#20026;&#19978;&#23618;&#30340;&#32034;&#24341;&#20540;&#65292;&#22914;&#26524;&#24403;&#19978;&#23618;&#27809;&#26377;_try_except&#22359;&#26102;&#65292;&#25191;&#34892;&#23436;&#27605;&#23601;&#20250;&#23558;trylevel&#20540;&#20462;&#25913;&#20026;-1&#12290;&#22240;&#27492;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;<strong class=" ">&#23427;&#26159;&#21160;&#24577;&#21464;&#21270;&#30340;&#65292;&#24182;&#19981;&#26159;&#22266;&#23450;&#20540;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-1_14-23-12.png" alt="images/download/attachments/2949166/image2023-6-1_14-23-12.png" width="600"  />
    </p>
<p   
>&#37027;&#20040;&#24403;&#21069;&#32534;&#35793;&#22120;&#29615;&#22659;&#20013;&#65292;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;_except_handler3&#23601;&#20250;&#26681;&#25454;trylevel&#36873;&#25321;scopetable&#25968;&#32452;&#20013;&#30340;&#32467;&#26500;&#20307;&#65292;&#28982;&#21518;&#25214;&#21040;&#32467;&#26500;&#20307;&#30340;IpfnFilter&#25104;&#21592;&#65292;&#21363;&#24322;&#24120;&#36807;&#28388;&#20989;&#25968;&#22320;&#22336;&#12290;</p>
    </div>
    <div class="section section-3" id="src-2949166_safe-id-aWQt5byC5bi4LV90cnlfZmluYWxseQ">
        <h3 class="heading "><span>_try_finally</span></h3>
<p   
>&#38500;&#20102;_try_except&#31243;&#24207;&#22359;&#20043;&#22806;&#65292;&#32534;&#35793;&#22120;&#36824;&#25552;&#20379;&#20102;_try_finally&#65292;&#19982;&#21069;&#32773;&#19981;&#21516;&#30340;&#65292;<strong class=" ">&#22312;_finally&#22359;&#20869;&#30340;&#20195;&#30721;&#19968;&#23450;&#20250;&#21435;&#25191;&#34892;</strong>&#65292;&#26080;&#35770;&#20320;_try&#22359;&#20869;&#26159;&#21542;&#20986;&#38169;&#12289;&#20013;&#26029;&#12289;&#27491;&#24120;&#65292;&#37117;&#21487;&#20197;&#24471;&#21040;&#25191;&#34892;&#12290;</p>
<p   
>&#22914;&#19979;&#22270;&#25152;&#31034;&#65292;&#26080;&#35770;&#20351;&#29992;continue&#12289;break&#25511;&#21046;&#65292;&#36824;&#26159;return&#36820;&#22238;&#65292;&#20134;&#25110;&#26159;&#35302;&#21457;&#24322;&#24120;&#65292;<strong class=" ">_finally&#22359;&#20869;&#30340;&#20195;&#30721;&#22987;&#32456;&#20250;&#34987;&#25191;&#34892;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-1_18-2-36.png" alt="images/download/attachments/2949166/image2023-6-1_18-2-36.png" width="600"  />
    </p>
<p   
>&#25105;&#20204;&#20197;return&#30340;&#20195;&#30721;&#20026;&#20363;&#65292;&#26469;&#30475;&#19968;&#19979;&#21453;&#27719;&#32534;&#65292;&#22914;&#19979;&#22270;&#25152;&#31034;&#65292;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;_try_finally&#31243;&#24207;&#22359;&#26102;&#65292;&#25193;&#23637;SEH&#32467;&#26500;&#20307;&#20013;&#30340;scopetable&#25104;&#21592;&#19982;_try_except&#19981;&#19968;&#26679;&#65292;<strong class=" ">&#39318;&#20808;&#26159;&#23427;&#30340;lpfnFilter&#36807;&#28388;&#20989;&#25968;&#22320;&#22336;&#26159;&#31354;&#30340;&#65292;&#22240;&#27492;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#36825;&#20010;&#25104;&#21592;&#26469;&#21028;&#26029;&#24403;&#21069;&#26159;&#21542;&#26159;_finally&#22359;</strong>&#65292;&#20854;&#27425;&#26159;&#23427;&#30340;<strong class=" ">lpfnHandler&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#22320;&#22336;&#25351;&#21521;&#30340;&#26159;_finally&#22359;&#20013;&#30340;&#20195;&#30721;&#22320;&#22336;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-1_18-13-13.png" alt="images/download/attachments/2949166/image2023-6-1_18-13-13.png" width="600"  />
    </p>
<p   
>&#24182;&#19988;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#22312;&#25191;&#34892;return&#35821;&#21477;&#20043;&#21069;&#65292;&#35843;&#29992;&#20102;&#19968;&#20010;&#21517;&#20026;_local_unwind2&#30340;&#20989;&#25968;&#65288;<strong class=" ">&#36825;&#20010;&#20989;&#25968;&#32763;&#35793;&#25104;&#20013;&#25991;&#23601;&#26159;&#23616;&#37096;&#23637;&#24320;&#30340;&#24847;&#24605;&#65292;&#27809;&#26377;&#21035;&#30340;&#21547;&#20041;</strong>&#65289;&#12290;&#25105;&#20204;&#21487;&#20197;&#32487;&#32493;&#36319;&#36827;_local_unwind2&#65292;&#20250;&#21457;&#29616;&#23427;&#35843;&#29992;&#20102;&#19968;&#20010;&#20989;&#25968;&#65292;&#21363;[ebx+esi*4+8]&#65292;&#36890;&#36807;&#23492;&#23384;&#22120;&#30340;&#20540;&#35745;&#31639;&#65292;&#25105;&#20204;&#26597;&#30475;&#23545;&#24212;&#22320;&#22336;&#20026;<strong class=" ">_finally&#22359;&#20013;&#30340;&#20195;&#30721;&#22320;&#22336;</strong>&#65292;&#36825;&#20063;&#23601;&#35299;&#37322;&#20102;&#20026;&#20160;&#20040;&#21487;&#20197;&#22312;return&#20043;&#21069;&#25191;&#34892;_finally&#22359;&#20013;&#30340;&#22320;&#22336;&#20102;&#65288;&#21363;_finally&#22359;&#20013;&#30340;&#20195;&#30721;&#19968;&#23450;&#24471;&#21040;&#25191;&#34892;&#65289;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-1_18-20-50.png" alt="images/download/attachments/2949166/image2023-6-1_18-20-50.png" width="600"  />
    </p>
<p   
>&#25105;&#20204;&#25509;&#30528;&#26469;&#30475;&#19979;&#38754;&#36825;&#27573;&#20195;&#30721;&#65292;&#23427;&#26377;&#19977;&#23618;_try&#65292;&#22806;&#23618;&#26159;_try_except&#65292;&#31532;&#20108;&#12289;&#19977;&#23618;&#37117;&#26159;_try_finally&#65292;&#21457;&#29983;&#24322;&#24120;&#30340;&#20195;&#30721;&#22788;&#20110;&#31532;&#19977;&#23618;&#65292;&#25353;&#29031;&#25105;&#20204;&#20043;&#21069;&#25152;&#23398;&#20064;&#30340;&#20869;&#23481;&#26469;&#30475;&#65292;&#19968;&#26086;&#35302;&#21457;&#24322;&#24120;&#65292;except_handler3&#20989;&#25968;&#20250;&#26681;&#25454;&#24403;&#21069;trylevel&#30340;&#20540;&#25214;&#21040;&#23545;&#24212;&#30340;&#32467;&#26500;&#20307;&#24182;&#23547;&#25214;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;lpfnFilter&#65292;<strong class=" ">&#20174;&#20869;&#33267;&#22806;&#65292;&#20174;&#31532;&#19977;&#23618;&#24320;&#22987;&#25214;&#65292;&#36890;&#36807;previousTryLevel&#26469;&#36880;&#23618;&#21521;&#19978;&#23547;&#25214;&#65292;&#20294;&#30001;&#20110;&#19977;&#23618;&#12289;&#20108;&#23618;&#37117;&#26159;_finally&#22359;&#65292;&#22240;&#27492;&#36807;&#28388;&#20989;&#25968;&#22320;&#22336;&#37027;&#19968;&#22359;&#30340;&#20540;&#26159;0</strong>&#65292;&#26368;&#32456;&#20250;&#25214;&#21040;&#31532;&#19968;&#23618;&#65292;&#20063;&#23601;&#26159;&#26368;&#22806;&#23618;&#30340;_except&#22359;&#65292;&#27492;&#26102;&#36807;&#28388;&#34920;&#36798;&#24335;&#20026;1&#65292;_except&#22359;&#20869;&#30340;&#20195;&#30721;&#24471;&#21040;&#25191;&#34892;&#65292;&#28982;&#21518;&#23601;&#20250;&#36820;&#22238;&#12290;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="keyword">void</code><code class="plain"> test()</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    _try</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        _try</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            _try</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                *(</code><code class="keyword">int</code><code class="plain">*)</code><code class="value">0</code><code class="plain"> = </code><code class="value">1</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">            _finally</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                printf(</code><code class="string">"Finally2 ... \n"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        _finally</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            printf(</code><code class="string">"Finally1 ... \n"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    _except(</code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        printf(</code><code class="string">"Except ... \n"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>&#27492;&#26102;&#23601;&#20250;&#26377;&#20010;&#38382;&#39064;&#65292;&#22312;&#20869;&#23618;&#30340;_finally&#22359;&#20195;&#30721;&#26159;&#21542;&#20250;&#24471;&#21040;&#25191;&#34892;&#21602;&#65311;&#25105;&#20204;&#21487;&#20197;&#23454;&#38469;&#36816;&#34892;&#19979;&#20195;&#30721;&#65292;&#22914;&#19979;&#22270;&#25152;&#31034;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#65292;_finally&#22359;&#30340;&#20195;&#30721;&#37117;&#24471;&#21040;&#20102;&#25191;&#34892;&#12290;<br/><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-2_15-48-1.png" alt="images/download/attachments/2949166/image2023-6-2_15-48-1.png" width="600"  />
    </p>
<p   
>&#37027;&#20040;&#22312;&#36825;&#37324;&#26159;&#20026;&#20160;&#20040;&#21602;&#65292;&#23454;&#38469;&#22312;&#27599;&#20010;_except&#22359;&#20869;&#20195;&#30721;&#25191;&#34892;&#20043;&#21069;&#65292;&#37117;&#20250;&#35843;&#29992;&#19968;&#27425;&#20840;&#23616;&#23637;&#24320;&#20989;&#25968;&#65292;&#21363;_global_unwind2&#20989;&#25968;&#65292;&#35813;&#20989;&#25968;&#20250;&#20174;&#35302;&#21457;&#24322;&#24120;&#30340;&#37027;&#20010;try&#24320;&#22987;&#65292;<strong class=" ">&#20381;&#27425;&#35843;&#29992;&#23616;&#37096;&#23637;&#24320;&#65292;&#36825;&#26679;&#23601;&#21487;&#20197;&#20445;&#35777;finally&#22359;&#35821;&#21477;&#19968;&#23450;&#20250;&#24471;&#21040;&#25191;&#34892;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-2_16-3-8.png" alt="images/download/attachments/2949166/image2023-6-2_16-3-8.png" width="600"  />
    </p>
    </div>
    </div>
    </div>
    <div class="section section-1" id="src-2949166_safe-id-aWQt5byC5bi4LeacquWkhOeQhuW8guW4uA">
        <h1 class="heading "><span>&#26410;&#22788;&#29702;&#24322;&#24120;</span></h1>
<p   
>&#22914;&#26524;VEH&#19982;SEH&#37117;&#27809;&#26377;&#23545;&#24322;&#24120;&#36827;&#34892;&#22788;&#29702;&#65292;&#36825;&#31181;&#24322;&#24120;&#25105;&#20204;&#23601;&#31216;&#20043;&#20026;<strong class=" ">&#26410;&#22788;&#29702;&#24322;&#24120;</strong>&#12290;&#22240;&#20026;&#25105;&#20204;&#26681;&#25454;&#20043;&#21069;&#20998;&#26512;&#20869;&#26680;&#31354;&#38388;&#24322;&#24120;&#30693;&#36947;&#65292;&#24403;&#27809;&#26377;&#20219;&#20309;&#26041;&#27861;&#21462;&#22788;&#29702;&#24322;&#24120;&#26102;&#20250;&#35843;&#29992;KeBugCheckEx&#20989;&#25968;&#21551;&#29992;&#34013;&#23631;&#65292;&#20869;&#26680;&#26410;&#22788;&#29702;&#24322;&#24120;&#30340;&#22788;&#29702;&#32467;&#26524;&#20063;&#24456;&#31616;&#21333;&#65292;<strong class=" ">&#22240;&#27492;&#26412;&#31456;&#33410;&#25152;&#23398;&#20064;&#30340;&#26159;&#29992;&#25143;&#31354;&#38388;&#30340;&#26410;&#22788;&#29702;&#24322;&#24120;</strong>&#12290;</p>
<p   
>&#25105;&#20204;&#39318;&#20808;&#32534;&#20889;&#19968;&#20010;&#31616;&#21333;&#30340;&#20195;&#30721;&#65292;&#21551;&#21160;&#19968;&#19979;&#65292;&#30475;&#23427;&#30340;&#35843;&#29992;&#26632;&#65292;&#25105;&#20204;&#21487;&#20197;&#30475;&#35265;&#65292;<strong class=" ">&#31243;&#24207;&#21551;&#21160;&#26102;&#24182;&#19981;&#26159;&#30452;&#25509;&#20174;main&#20989;&#25968;&#24320;&#22987;&#25191;&#34892;&#30340;&#65292;&#23427;&#30340;&#19978;&#23618;&#26377;mainCRTStartup&#12289;KERNEL32!7c816d4f()</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-2_16-49-7.png" alt="images/download/attachments/2949166/image2023-6-2_16-49-7.png" width="600"  />
    </p>
<p   
>&#25105;&#20204;&#21487;&#20197;&#36319;&#36827;<strong class=" ">KERNEL32!7c816d4f</strong>&#65292;&#26368;&#32456;&#23601;&#20250;&#21457;&#29616;&#23427;&#22312;&#36825;&#19968;&#23618;&#23558;SEH&#25346;&#21040;&#38142;&#34920;&#19978;&#65292;&#20063;&#23601;&#35828;&#23454;&#38469;&#19978;&#22312;&#20837;&#21475;&#31243;&#24207;&#37096;&#20998;&#65292;<strong class=" ">&#20063;&#32473;&#25105;&#20204;&#21152;&#20102;&#19968;&#36947;&#24322;&#24120;&#22788;&#29702;&#30340;&#38450;&#32447;</strong>&#12290;&#22240;&#27492;main&#20989;&#25968;&#22914;&#26524;&#21457;&#29983;&#24322;&#24120;&#65292;&#19988;&#22312;&#23427;&#30340;SEH&#38142;&#34920;&#20013;&#26410;&#33021;&#26597;&#25214;&#21040;&#33021;&#22815;&#22788;&#29702;&#24322;&#24120;&#30340;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#65292;&#37027;&#20040;_except_handler3&#20989;&#25968;&#21017;&#20250;&#36890;&#36807;previousTryLevel&#26597;&#25214;&#26368;&#22806;&#23618;&#30340;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#65292;<strong class=" ">&#20063;&#23601;&#26159;&#22312;&#36825;&#25346;&#19978;&#21435;&#30340;SEH&#32467;&#26500;&#20307;&#20013;&#30340;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;</strong>&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-5_11-31-46.png" alt="images/download/attachments/2949166/image2023-6-5_11-31-46.png" width="600"  />
    </p>
<p   
>&#22312;&#36825;&#37324;&#65292;&#36825;&#20010;&#20989;&#25968;&#23454;&#38469;&#19978;&#23601;&#26159;<strong class=" ">Kernel32.dll&#27169;&#22359;&#20013;&#30340;BaseProcessStart&#20989;&#25968;</strong>&#65292;&#22312;&#35813;&#20989;&#25968;&#20869;&#35843;&#29992;&#20102;&#21478;&#22806;&#19968;&#20010;&#20989;&#25968;_SEH_prolog&#65292;&#23427;&#30340;&#20316;&#29992;&#23601;&#26159;&#28155;&#21152;SEH&#21040;&#38142;&#34920;&#19978;&#12290;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-2_17-20-35.png" alt="images/download/attachments/2949166/image2023-6-2_17-20-35.png" width="600"  />
    </p>
<p   
>&#37027;&#20040;&#38500;&#20102;&#20837;&#21475;&#31243;&#24207;&#20197;&#22806;&#65292;&#22914;&#26524;&#25105;&#20204;&#21478;&#36215;&#19968;&#20010;&#32447;&#31243;&#65292;&#26159;&#21542;&#20063;&#20250;&#32473;&#25105;&#20204;&#25552;&#20379;&#19968;&#20010;&#24322;&#24120;&#22788;&#29702;&#30340;&#38450;&#32447;&#21602;&#65292;&#25105;&#20204;&#21487;&#20197;&#32534;&#20889;&#19968;&#27573;&#20195;&#30721;&#26469;&#21478;&#36215;&#19968;&#20010;&#32447;&#31243;&#65306;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">#include &lt;stdio.h&gt;</code></div>
<div class="line"><code class="plain">#include &lt;windows.h&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">DWORD WINAPI ThreadProc(LPVOID lpParam)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">int</code><code class="plain"> x = </code><code class="value">1</code><code class="plain">;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> </code><code class="value">0</code><code class="plain">;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">void</code><code class="plain"> main(</code><code class="keyword">int</code><code class="plain"> argc, </code><code class="keyword">char</code><code class="plain">* argv[])</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    CreateThread(NULL, </code><code class="value">0</code><code class="plain">, ThreadProc, NULL, </code><code class="value">0</code><code class="plain">, NULL);</code></div>
<div class="line"><code class="plain">    getchar();</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>&#25105;&#20204;&#22312;&#26032;&#32447;&#31243;&#30340;&#20195;&#30721;&#20013;&#19979;&#26029;&#28857;&#65292;&#26597;&#30475;&#35843;&#29992;&#26632;&#65292;&#22238;&#28335;&#36319;&#36394;&#36807;&#21435;&#65292;&#20250;&#21457;&#29616;&#20063;&#20250;&#32473;&#23427;&#19968;&#20010;SEH&#25346;&#20837;&#24322;&#24120;&#38142;&#34920;&#20013;&#65306;</p>
<p   
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-5_11-33-19.png" alt="images/download/attachments/2949166/image2023-6-5_11-33-19.png" width="600"  />
    </p>
<p   
>    <span style="color: #000000;">
&#25105;&#20204;&#20063;&#21487;&#20197;&#36890;&#36807;IDA&#26469;&#30475;&#36825;&#20010;&#22320;&#22336;&#23545;&#24212;&#30340;&#20989;&#25968;&#65292;&#21363;BaseThreadStart&#65292;&#23427;<strong class=" ">&#30830;&#23454;&#20063;&#35843;&#29992;&#20102;&#19968;&#20010;_SEH_prolog&#20989;&#25968;&#29992;&#20110;&#28155;&#21152;SEH&#33267;&#38142;&#34920;&#19978;</strong>&#12290;    </span>
</p>
<p   
>    <span style="color: #000000;">
<img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-5_11-25-2.png" alt="images/download/attachments/2949166/image2023-6-5_11-25-2.png"  height="250" />
    </span>
</p>
<p   
>    <span style="color: #000000;">
&#32508;&#19978;&#25152;&#36848;&#65292;&#25105;&#20204;&#21487;&#20197;&#24471;&#20986;&#32467;&#35770;&#22823;&#37096;&#20998;&#24773;&#20917;&#19979;&#65292;&#26080;&#35770;&#26159;&#36827;&#31243;&#30340;&#20837;&#21475;&#32447;&#31243;&#36824;&#26159;&#21478;&#36215;&#30340;&#32447;&#31243;&#65292;&#37117;&#20250;&#34987;&#28155;&#21152;&#30340;&#24322;&#24120;&#22788;&#29702;&#20989;&#25968;&#32473;&#22788;&#29702;&#25481;&#65292;<strong class=" ">&#25152;&#20197;&#26410;&#22788;&#29702;&#24322;&#24120;&#30340;&#24773;&#20917;&#19968;&#33324;&#26159;&#19981;&#23384;&#22312;&#30340;</strong>&#12290;    </span>
</p>
<p   
>    <span style="color: #000000;">
&#25105;&#20204;&#21487;&#20197;&#23558;<strong class=" ">&#36825;&#20010;&#26368;&#21518;&#19968;&#36947;&#38450;&#32447;</strong>&#25191;&#34892;&#36807;&#31243;&#24635;&#32467;&#20026;&#22914;&#19979;&#30340;&#20266;&#20195;&#30721;&#65292;&#24403;&#31243;&#24207;&#26377;&#24322;&#24120;&#21457;&#29983;&#26102;&#65292;&#33509;&#21407;&#20808;&#22534;&#26632;&#30340;SEH&#22343;&#26410;&#22788;&#29702;&#65292;<strong class=" ">&#37027;&#20040;&#36825;&#20010;&#20989;&#25968;&#19968;&#23450;&#20250;&#25191;&#34892;</strong>&#65306;    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">__try</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">__except(UnhandledExceptionFilter(GetExceptionInformation())</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">//终止线程</code></div>
<div class="line"><code class="plain">    </code><code class="comments">//终止进程</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>&#22914;&#26524;UnhandledExceptionFilter&#20989;&#25968;&#36820;&#22238;&#20026;0&#65292;&#21363;EXCEPTION_CONTINUE_SEARCH&#65292;&#37027;&#23601;&#30495;&#30340;&#26159;&#25214;&#19981;&#21040;&#23545;&#24212;&#30340;&#24322;&#24120;&#22788;&#29702;&#31243;&#24207;&#20102;&#65292;&#20294;&#36825;&#31181;&#24773;&#20917;&#22914;&#26524;&#20320;&#30340;&#31243;&#24207;&#22312;&#27809;&#26377;&#34987;&#35843;&#35797;&#30340;&#24773;&#20917;&#19979;&#26159;&#19981;&#20250;&#21457;&#29983;&#30340;&#65292;<strong class=" ">&#21482;&#26377;&#31243;&#24207;&#34987;&#35843;&#35797;&#26102;&#65292;&#25165;&#20250;&#23384;&#22312;&#26410;&#22788;&#29702;&#24322;&#24120;</strong>&#12290;</p>
<p   
>UnhandledExceptionFilter&#20989;&#25968;&#30340;&#25191;&#34892;&#27969;&#31243;&#22914;&#19979;&#65306;</p>
<ol class=" "><li class=" "><p   
>&#36890;&#36807;NtQueryinformationProcess&#20989;&#25968;&#26597;&#35810;&#24403;&#21069;&#36827;&#31243;&#26159;&#21542;&#27491;&#22312;&#34987;&#35843;&#35797;&#12290;</p>
</li><li class=" "><p   
>&#22914;&#26524;&#34987;&#35843;&#35797;&#65292;&#36820;&#22238;EXCEPTION_CONTINUE_SEARCH&#65292;&#27492;&#26102;&#20250;&#36827;&#20837;&#31532;&#20108;&#36718;&#20998;&#21457;&#12290;</p>
</li><li class=" "><p   
>&#22914;&#26524;&#27809;&#26377;&#34987;&#35843;&#35797;&#65306;</p>
<ol class=" "><li class=" "><p   
>&#26597;&#35810;&#26159;&#21542;&#36890;&#36807;SetUnhandledExceptionFilter&#27880;&#20876;&#22788;&#29702;&#20989;&#25968;&#65292;&#22914;&#26524;&#26377;&#23601;&#35843;&#29992;&#65307;</p>
</li><li class=" "><p   
>&#22914;&#26524;&#27809;&#26377;&#36890;&#36807;SetUnhandledExceptionFilter&#27880;&#20876;&#22788;&#29702;&#20989;&#25968;&#65292;&#23601;&#20250;&#24377;&#20986;&#31383;&#21475;&#35753;&#29992;&#25143;&#36873;&#25321;&#32456;&#27490;&#31243;&#24207;&#36824;&#26159;&#21551;&#21160;&#21363;&#26102;&#35843;&#35797;&#22120;&#65307;</p>
</li><li class=" "><p   
>&#22914;&#26524;&#29992;&#25143;&#27809;&#26377;&#21551;&#29992;&#21363;&#26102;&#35843;&#35797;&#22120;&#65292;&#37027;&#20040;&#35813;&#20989;&#25968;&#36820;&#22238;EXCEPTION_EXECUTE_HANDLER&#12290;</p>
</li></ol></li></ol><p   
>&#22240;&#27492;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#22914;&#19979;&#30340;&#20195;&#30721;&#26469;&#36827;&#34892;&#21453;&#35843;&#35797;&#65292;&#32534;&#35793;&#36825;&#20010;&#31243;&#24207;&#65292;&#27491;&#24120;&#25171;&#24320;&#26159;&#20250;&#25191;&#34892;printf&#30340;&#65292;&#20294;&#22914;&#26524;&#36890;&#36807;OD&#25171;&#24320;&#21017;&#20250;&#20572;&#27490;&#36816;&#34892;&#12290;</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="plain">#include &lt;stdio.h&gt;</code></div>
<div class="line"><code class="plain">#include &lt;windows.h&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">long</code><code class="plain"> _stdcall callback(_EXCEPTION_POINTERS* excp)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    excp-&gt;ContextRecord-&gt;Ecx = </code><code class="value">1</code><code class="plain">;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> EXCEPTION_CONTINUE_EXECUTION;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">void</code><code class="plain"> main(</code><code class="keyword">int</code><code class="plain"> argc, </code><code class="keyword">char</code><code class="plain">* argv[])</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// 注册一个最顶层异常处理函数</code></div>
<div class="line"><code class="plain">    SetUnhandledExceptionFilter(callback);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// 除0异常</code></div>
<div class="line"><code class="plain">    _asm</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        xor edx,edx</code></div>
<div class="line"><code class="plain">        xor ecx,ecx</code></div>
<div class="line"><code class="plain">        mov eax,</code><code class="value">0x10</code></div>
<div class="line"><code class="plain">        idiv ecx</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    </code><code class="comments">// 程序正常执行</code></div>
<div class="line"><code class="plain">    printf(</code><code class="string">"Running ... "</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    getchar();</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p  class="auto-cursor-target" 
>&#22914;&#19979;&#22270;&#25152;&#31034;&#25105;&#20204;&#20351;&#29992;&#32431;&#20928;&#29256;&#30340;Ollydbg&#35843;&#35797;&#35813;&#31243;&#24207;&#23601;&#27809;&#27861;&#25191;&#34892;&#27491;&#24120;&#30340;&#20195;&#30721;&#65292;&#22914;&#26524;&#25105;&#20204;&#20351;&#29992;&#24102;&#25554;&#20214;&#29256;&#30340;OD&#65292;&#22914;&#21566;&#29233;&#30772;&#35299;&#30340;OD&#21017;&#21487;&#20197;&#30452;&#25509;&#32469;&#36807;&#21453;&#35843;&#35797;&#65306;</p>
<p  class="auto-cursor-target" 
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-5_14-46-35.png" alt="images/download/attachments/2949166/image2023-6-5_14-46-35.png" width="600"  />
    </p>
<p  class="auto-cursor-target" 
>&#32469;&#36807;&#21453;&#35843;&#35797;&#30340;&#21407;&#29702;&#24456;&#31616;&#21333;&#65292;&#25105;&#20204;&#30693;&#36947;UnhandledExceptionFilter&#20989;&#25968;&#26159;&#36890;&#36807;NtQueryInformationProcess&#26469;&#21028;&#26029;&#26159;&#21542;&#34987;&#35843;&#35797;&#30340;&#65292;&#32780;NtQueryInformationProcess&#26159;&#36890;&#36807;DebugPort&#30340;&#20540;&#26469;&#21028;&#26029;&#31243;&#24207;&#26159;&#21542;&#27491;&#22312;&#34987;&#35843;&#35797;&#65292;&#22240;&#27492;&#25105;&#20204;&#21482;&#38656;&#35201;Hook&#20102;NtQueryInformationProcess&#65292;&#20462;&#25913;DebugPort&#30340;&#20540;&#23601;&#21487;&#20197;&#32469;&#36807;&#21453;&#35843;&#35797;&#20102;&#12290;</p>
<p  class="auto-cursor-target" 
>&#26368;&#21518;&#25105;&#20204;&#20877;&#26469;&#30475;&#19968;&#19979;KiUserExceptionDispatcher&#20989;&#25968;&#65292;&#23427;&#39318;&#20808;&#20250;&#35843;&#29992;RtlDispatchException&#65292;&#36825;&#20010;&#20989;&#25968;&#21253;&#25324;&#20102;&#23545;VEH&#12289;SEH&#30340;&#26597;&#25214;&#65292;&#20197;&#21450;&#26597;&#30475;&#26159;&#21542;&#23384;&#22312;&#39030;&#23618;&#20989;&#25968;&#65292;&#20197;&#21450;&#26159;&#21542;&#34987;&#35843;&#35797;&#12290;&#20840;&#37096;&#37117;&#21028;&#26029;&#23436;&#20102;&#20197;&#21518;&#65292;&#36820;&#22238;&#19968;&#20010;&#24067;&#23572;&#20540;&#65292;<strong class=" ">&#36820;&#22238;&#20026;&#30495;&#65292;&#35843;&#29992;ZwContinue&#20877;&#36827;&#20837;0&#29615;&#65292;&#36820;&#22238;&#20026;&#20551;&#65292;&#35843;&#29992;ZwRaiseException&#36827;&#34892;&#31532;&#20108;&#36718;&#24322;&#24120;&#20998;&#21457;</strong>&#12290;</p>
<p  class="auto-cursor-target" 
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-5_14-54-10.png" alt="images/download/attachments/2949166/image2023-6-5_14-54-10.png" width="600"  />
    </p>
<p  class="auto-cursor-target" 
>&#26368;&#21518;&#25105;&#20204;&#23601;&#21487;&#20197;&#20102;&#35299;&#25972;&#20010;&#24322;&#24120;&#20998;&#21457;&#12289;&#22788;&#29702;&#30340;&#36807;&#31243;&#20102;&#65292;&#22914;&#19979;&#22270;&#25152;&#31034;&#65306;</p>
<p  class="auto-cursor-target" 
><img  class="confluence-embedded-image"  src="images/download/attachments/2949166/image2023-6-5_14-59-24.png" alt="images/download/attachments/2949166/image2023-6-5_14-59-24.png" width="600"  />
    </p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="%E4%BA%8B%E4%BB%B6%E7%AD%89%E5%BE%85.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>&#20107;&#20214;&#31561;&#24453;</span>
        </a>
                <a href="%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>&#20869;&#23384;&#31649;&#29702;</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
